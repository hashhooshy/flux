<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for powerful data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- qrcode.js CDN for functional QR code generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDKs for Cloud Firestore and Authentication -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global variables for Firebase access
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Wait for DOM to be ready before initializing Firebase
        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(window.firebaseConfig).length > 0) {
                const app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                window.storage = getStorage(app);
            
                try {
                    if (window.initialAuthToken) {
                        await signInWithCustomToken(window.auth, window.initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                }

                // Listen for auth state changes to update the UI
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        console.log("User is signed in with UID:", user.uid);
                        window.userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${user.uid}`;
                        if (window.renderFluxApp) { // Ensure renderFluxApp is defined before calling
                            window.renderFluxApp(); 
                        }
                    } else {
                        console.log("User is signed out.");
                        window.userId = null;
                        document.getElementById('user-id-display').textContent = 'Not signed in';
                    }
                });
            } else {
                console.warn("Firebase config not available. Cloud features will be disabled.");
            }
        });
    </script>
    <style>
        /* General styling for a nice, clean look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Style for the custom modal dialog */
        .custom-alert-overlay, .custom-confirm-overlay, .custom-prompt-overlay, .flux-modal-overlay, .toast-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .custom-alert-box, .custom-confirm-box, .custom-prompt-box, .flux-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            min-width: 300px;
            text-align: center;
            max-height: 80vh; /* Set a max height for the modal */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        
        /* Carousel-specific styles */
        .carousel-container {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .carousel-slides {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }

        .carousel-slide {
            min-width: 100%;
            flex-shrink: 0;
            display: none; /* Hide all slides by default */
        }
        .carousel-slide.active {
            display: block;
        }

        .carousel-slide img {
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            padding: 1rem;
            z-index: 10;
            transition: background-color 0.3s;
        }
        .carousel-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .carousel-prev {
            left: 0;
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .carousel-next {
            right: 0;
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        /* Iframe-specific styles */
        #iframe-view-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #iframe-container {
            flex-grow: 1;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Chart container styles */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
            margin-top: 1rem;
        }

        /* Circular progress styling */
        .circular-progress {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circular-progress svg {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotate(-90deg);
        }
        .circular-progress svg circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        
        /* Modal styling */
        .flux-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .flux-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 500px;
            min-width: 300px;
            text-align: center;
        }

        /* Styling for the new single-textarea editor */
        #flux-editor {
            width: 100%;
            height: 100%;
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0;
            padding: 1rem;
            border: none;
            background-color: white; /* Changed to white */
            color: #1f2937; /* Changed to dark gray for readability */
            white-space: pre;
            word-wrap: normal;
            resize: none;
            outline: none;
            font-family: 'Fira Code', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
        }
        #flux-editor::placeholder {
            color: #6b7280; /* Darker placeholder text for visibility on white background */
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
            pointer-events: none; /* Allows clicks to pass through */
            background-color: transparent; /* Overlay should be transparent */
        }
        .toast-item {
            background-color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: #333;
            font-size: 0.875rem;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOut 4s forwards;
            pointer-events: auto; /* Re-enable pointer events for the toast itself */
        }
        .toast-item.success { border-left: 5px solid #10B981; } /* Green */
        .toast-item.error { border-left: 5px solid #EF4444; }   /* Red */
        .toast-item.info { border-left: 5px solid #3B82F6; }   /* Blue */
        .toast-item.warning { border-left: 5px solid #F59E0B; } /* Yellow */

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #333; /* Default color, can be overridden */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Accordion */
        .accordion-header {
            cursor: pointer;
            padding: 1rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-content {
            padding: 1rem;
            background-color: #ffffff;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out;
        }
        .accordion-item.active .accordion-content {
            max-height: 500px; /* Adjust as needed */
            transition: max-height 0.5s ease-in;
        }
        .accordion-icon {
            transition: transform 0.3s ease-out;
        }
        .accordion-item.active .accordion-icon {
            transform: rotate(90deg);
        }

        /* Tabs */
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-button {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-weight: 500;
            color: #6b7280;
            transition: color 0.3s, border-color 0.3s;
        }
        .tab-button.active {
            color: #4F46E5;
            border-bottom: 2px solid #4F46E5;
        }
        .tab-content {
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Main Container -->
    <div class="min-h-screen flex flex-col lg:flex-row items-start justify-center p-4 gap-4">

        <!-- Code Editor and Interpreter Input -->
        <div id="main-app-container" class="w-full lg:w-1/2 p-4 bg-white rounded-xl shadow-2xl flex flex-col h-[70vh] lg:h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-indigo-600">Flux Editor</h2>
                <button id="commands-list-btn" class="p-2 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            <!-- The new single textarea editor -->
            <textarea
                id="flux-editor"
                spellcheck="false"
                class="font-mono text-sm flex-grow border border-gray-300 rounded-lg"
                placeholder="Enter your Flux code here..."
            ></textarea>
            
            <div id="error-message" class="mt-4 p-3 bg-red-100 text-red-700 border border-red-400 rounded-lg font-mono text-sm hidden">
                <p id="error-message-text"></p>
            </div>
        </div>

        <!-- Rendered Output -->
        <div id="rendered-app-container" class="w-full lg:w-1/2 p-4 bg-white rounded-xl shadow-2xl flex flex-col h-auto lg:h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Rendered Flux Application</h2>
            
            <!-- User ID Display -->
            <p id="user-id-display" class="text-sm text-gray-500 mb-4 font-mono"></p>

            <!-- Standard Flux Output Container -->
            <div id="rendered-output" class="flex-grow p-4 bg-gray-50 rounded-lg">
                <div id="dynamic-output" class="hidden">
                    <!-- Dynamic content from button clicks will be appended here -->
                </div>
            </div>

            <!-- Iframe Container (Hidden by default) -->
            <div id="iframe-view-container" class="hidden">
                <div id="iframe-container" class="flex-grow"></div>
            </div>
        </div>

    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="custom-alert-overlay hidden">
      <div class="custom-alert-box">
        <p id="custom-alert-text" class="text-gray-800"></p>
        <div class="mt-4 flex justify-center space-x-4">
            <button id="custom-alert-close" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
        </div>
      </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="custom-confirm-overlay hidden">
        <div class="custom-confirm-box">
            <p id="custom-confirm-text" class="text-gray-800"></p>
            <div class="mt-4 flex justify-center space-x-4">
                <button id="custom-confirm-ok" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
                <button id="custom-confirm-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Prompt Modal -->
    <div id="custom-prompt-modal" class="custom-prompt-overlay hidden">
        <div class="custom-prompt-box">
            <p id="custom-prompt-text" class="text-gray-800"></p>
            <input type="text" id="custom-prompt-input" class="w-full h-10 px-4 mt-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter value">
            <div class="mt-4 flex justify-center space-x-4">
                <button id="custom-prompt-ok" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
                <button id="custom-prompt-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>


    <script>
        // === Custom Alert Function (Replaces alert()) ===
        const showCustomAlert = (message) => {
            const modal = document.getElementById('custom-alert-modal');
            const text = document.getElementById('custom-alert-text');
            const closeBtn = document.getElementById('custom-alert-close');
            text.innerHTML = message;
            modal.classList.remove('hidden');
            
            closeBtn.onclick = () => modal.classList.add('hidden');
        };

        // === Custom Confirm Function (Replaces confirm()) ===
        const showCustomConfirm = (message) => {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-confirm-modal');
                const text = document.getElementById('custom-confirm-text');
                const okBtn = document.getElementById('custom-confirm-ok');
                const cancelBtn = document.getElementById('custom-confirm-cancel');

                text.textContent = message;
                modal.classList.remove('hidden');

                okBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };
            });
        };

        // === Custom Prompt Function (Replaces prompt()) ===
        const showCustomPrompt = (message, placeholder = '') => {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-prompt-modal');
                const text = document.getElementById('custom-prompt-text');
                const input = document.getElementById('custom-prompt-input');
                const okBtn = document.getElementById('custom-prompt-ok');
                const cancelBtn = document.getElementById('custom-prompt-cancel');

                text.textContent = message;
                input.value = ''; // Clear previous input
                input.placeholder = placeholder;
                modal.classList.remove('hidden');

                okBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(input.value);
                };
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(null); // Return null if cancelled
                };
            });
        };

        // === Toast Notification ===
        const showToast = (message, type = 'info', duration = 3000) => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `toast-item ${type}`;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, duration);
        };

        // === State Variables (replaces React's useState) ===
        const activeModals = {};
        const state = {}; // New state object to hold dynamic values
        const fluxIntervals = {}; // To store interval IDs for polling
        const countdownTimers = {}; // To store countdown interval IDs

        // === DOM Element References ===
        const editor = document.getElementById('flux-editor');
        const outputContainer = document.getElementById('rendered-output');
        const dynamicOutputContainer = document.getElementById('dynamic-output');
        const iframeViewContainer = document.getElementById('iframe-view-container');
        const iframeContainer = document.getElementById('iframe-container');
        const errorContainer = document.getElementById('error-message');
        const errorText = document.getElementById('error-message-text');
        const commandsListBtn = document.getElementById('commands-list-btn');

        // --- New `wait` function for async rendering ---
        const wait = (seconds) => new Promise(resolve => setTimeout(resolve, seconds * 1000));

        // --- View management for Iframe ---
        const showIframeView = (url, htmlContent = null) => {
            outputContainer.classList.add('hidden');
            iframeViewContainer.classList.remove('hidden');
            const iframe = document.createElement('iframe');
            if (url) {
                iframe.src = url;
            } else if (htmlContent) {
                iframe.srcdoc = htmlContent;
            }
            iframeContainer.innerHTML = ''; // Clear previous iframe
            iframeContainer.appendChild(iframe);
        };

        const showMainAppView = () => {
            iframeViewContainer.classList.add('hidden');
            outputContainer.classList.remove('hidden');
            iframeContainer.innerHTML = '';
        };

        // --- Simple Expression Evaluator for 'if' conditions ---
        const safeEvaluateCondition = (conditionString) => {
            // Basic parsing for simple comparisons like "state.myVar == 'value'"
            // Supports: ==, !=, >, <, >=, <=
            const match = conditionString.match(/^(state\.[a-zA-Z0-9_]+)\s*(==|!=|>=|<=|>|<)\s*(.+)$/);
            if (!match) {
                console.error("Invalid condition format:", conditionString);
                return false;
            }

            let [, leftPath, operator, rightValueStr] = match;
            
            // Resolve left operand from state
            let leftValue = state;
            const pathParts = leftPath.substring(6).split('.'); // Remove 'state.'
            for (const part of pathParts) {
                if (leftValue && typeof leftValue === 'object' && leftValue.hasOwnProperty(part)) {
                    leftValue = leftValue[part];
                } else {
                    leftValue = undefined; // Path not found
                    break;
                }
            }

            // Parse right operand
            let rightValue;
            if (rightValueStr.startsWith("'") && rightValueStr.endsWith("'")) {
                rightValue = rightValueStr.slice(1, -1); // String literal
            } else if (rightValueStr.toLowerCase() === 'true') {
                rightValue = true;
            } else if (rightValueStr.toLowerCase() === 'false') {
                rightValue = false;
            } else if (!isNaN(Number(rightValueStr))) {
                rightValue = Number(rightValueStr); // Number
            } else {
                rightValue = rightValueStr; // Treat as raw string
            }

            // Perform comparison
            switch (operator) {
                case '==': return leftValue == rightValue;
                case '!=': return leftValue != rightValue;
                case '>': return leftValue > rightValue;
                case '<': return leftValue < rightValue;
                case '>=': return leftValue >= rightValue;
                case '<=': return leftValue <= rightValue;
                default: return false;
            }
        };

        // --- Commands List Function ---
        const showCommandsList = () => {
            const commandsList = `
                <h3 class="font-bold text-xl mb-4">Available Commands</h3>
                <ul class="text-left text-sm">
                    <li class="mb-2"><strong>heading:</strong> <code>text="string", size="h1|h2|h3|h4", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>paragraph:</strong> <code>text="string", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>list:</strong> <code>title="string", items=["item1", "item2"], listStyle="numbered|bulleted", itemStyle="tailwind-style-classes", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>button:</strong> <code>text="string", style="tailwind-style-classes", onClick="flux commands"</code></li>
                    <li class="mb-2"><strong>divider:</strong> <code>color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>card:</strong> <code>title="string", text="string", style="tailwind-style-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>show:</strong> <code>id="string"</code></li>
                    <li class="mb-2"><strong>hide:</strong> <code>id="string"</code></li>
                    <li class="mb-2"><strong>wait:</strong> <code>seconds="number"</code></li>
                    <li class="mb-2"><strong>input:</strong> <code>id="string", placeholder="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2"><strong>textarea:</strong> <code>id="string", placeholder="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2"><strong>alert:</strong> <code>text="string", type="success|warning|error|info"</code></li>
                    <li class="mb-2"><strong>progress:</strong> <code>label="string", value="number", max="number", id="string"</code></li>
                    <li class="mb-2"><strong>link:</strong> <code>text="string", url="string"</code> (loads URL in iframe)</li>
                    <li class="mb-2"><strong>iframe:</strong> <code>url="string"</code> (loads URL in iframe)</li>
                    <li class="mb-2"><strong>search:</strong> <code>query="string"</code></li>
                    <li class="mb-2"><strong>table:</strong> <code>headers=["Header1", "Header2"], rows=[["data1", "data2"]], id="string(optional)"</code></li>
                    <li class="mb-2"><strong>carousel:</strong> <code>images=["url1", "url2"], id="string(optional)"</code></li>
                    <li class="mb-2"><strong>chart:</strong> <code>type="bar|line|pie", labels=["label1", "label2"], data=[10, 20], title="string (optional)", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>form:</strong> <code>id="string"</code> (a container for inputs)</li>
                    <li class="mb-2"><strong>submit:</strong> <code>formId="string", text="string", onClick="flux commands"</code></li>
                    <li class="mb-2"><strong>store:</strong> <code>id="string", value="string"</code> (deprecated, use 'set')</li>
                    <li class="mb-2"><strong>load:</strong> <code>id="string"</code> (deprecated, use 'get')</li>
                    <li class="mb-2 font-bold mt-4">--- New UI Commands ---</li>
                    <li class="mb-2"><strong>image:</strong> <code>src="url", alt="text", width="px|% (optional)", height="px|% (optional)", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>video:</strong> <code>src="url", controls="true|false", autoplay="true|false", loop="true|false", muted="true|false", width="px|% (optional)", height="px|% (optional)", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>audio:</strong> <code>src="url", controls="true|false", autoplay="true|false", loop="true|false", muted="true|false", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>iframe.html:</strong> <code>content="<html content>", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>codeblock:</strong> <code>code="string", lang="javascript|html|css|python|plaintext", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>grid:</strong> <code>columns="number", gap="number", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>flex:</strong> <code>direction="row|col", justify="start|end|center|between|around|evenly", align="start|end|center|stretch|baseline", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>accordion:</strong> <code>title="string", content="string", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>tabs:</strong> <code>id="string", tabs=["Tab 1", "Tab 2"], content=["Content 1", "Content 2"]</code></li>
                    <li class="mb-2"><strong>rating:</strong> <code>value="number", max="number", size="number(px)", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>slider:</strong> <code>id="string", min="number", max="number", value="number", step="number", style="tailwind-classes"</code></li>
                    <li class="mb-2"><strong>date-picker:</strong> <code>id="string", label="string", value="YYYY-MM-DD (optional)", style="tailwind-classes"</code></li>
                    <li class="mb-2"><strong>time-picker:</strong> <code>id="string", label="string", value="HH:MM (optional)", style="tailwind-classes"</code></li>
                    <li class="mb-2"><strong>color-picker:</strong> <code>id="string", label="string", value="#RRGGBB (optional)", style="tailwind-classes"</code></li>
                    <li class="mb-2"><strong>qr-code:</strong> <code>text="string", size="number(px)", color="hex", background="hex", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>map:</strong> <code>query="location string", zoom="number", width="px|%", height="px|%", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>toast:</strong> <code>message="string", type="success|error|info|warning", duration="number(ms)"</code></li>
                    <li class="mb-2"><strong>spinner:</strong> <code>size="number(px)", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>badge:</strong> <code>text="string", color="tailwind-color-class"</code></li>
                    <li class="mb-2"><strong>circular-progress:</strong> <code>value="number", max="number", size="number(px)", color="tailwind-color-class"</code></li>
                    <li class="mb-2"><strong>toggle:</strong> <code>id="string", label="string"</code></li>
                    <li class="mb-2"><strong>radio-group:</strong> <code>name="string", options=["option1", "option2"]</code></li>
                    <li class="mb-2"><strong>checkbox-group:</strong> <code>name="string", options=["option1", "option2"]</code></li>
                    <li class="mb-2"><strong>dropdown:</strong> <code>id="string", options=["option1", "option2"], label="string"</code></li>
                    <li class="mb-2"><strong>modal:</strong> <code>id="string", title="string", text="string"</code></li>
                    <li class="mb-2"><strong>button.modal:</strong> <code>text="string", modalId="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2 font-bold mt-4">--- New Logic & Data Commands ---</li>
                    <li class="mb-2"><strong>set:</strong> <code>key="string", value="string|number|boolean|array|object"</code> (stores in app state)</li>
                    <li class="mb-2"><strong>get:</strong> <code>key="string", targetId="string"</code> (retrieves from state and sets element value)</li>
                    <li class="mb-2"><strong>get.input:</strong> <code>id="string", key="string"</code> (retrieves value from input element and stores in state)</li>
                    <li class="mb-2"><strong>if:</strong> <code>condition="state.key == 'value'", then="flux commands", else="flux commands"</code></li>
                    <li class="mb-2"><strong>for:</strong> <code>collection="state.myArray", as="item", do="flux commands"</code></li>
                    <li class="mb-2"><strong>call:</strong> <code>function="functionName", args=["arg1", "arg2"]</code></li>
                    <li class="mb-2"><strong>toast:</strong> <code>message="string", type="success|error|info|warning", duration="number(ms)"</code></li>
                    <li class="mb-2 font-bold mt-4">--- Firebase Commands ---</li>
                    <li class="mb-2"><strong>firebase.set:</strong> <code>path="collection/document", data="{key: 'value'}"</code></li>
                    <li class="mb-2"><strong>firebase.get:</strong> <code>path="collection/document", key="stateKey"</code></li>
                    <li class="mb-2"><strong>firebase.update:</strong> <code>path="collection/document", data="{key: 'value'}"</code></li>
                    <li class="mb-2"><strong>firebase.delete:</strong> <code>path="collection/document"</code></li>
                    <li class="mb-2"><strong>firebase.listen:</strong> <code>path="collection/document", key="stateKey"</code> (listens for real-time changes)</li>
                </ul>
            `;
            showCustomAlert(commandsList);
        };

        commandsListBtn.onclick = showCommandsList;

        const renderElement = (command, args, targetElement = dynamicOutputContainer) => {
            const newElement = document.createElement('div');
            newElement.setAttribute('data-id', args.id || '');
            newElement.className = 'my-2';

            const applyStyle = (el, style) => {
                if (style) {
                    const classList = style.split(' ').filter(c => c.trim() !== '');
                    el.classList.add(...classList);
                }
            };
            
            const handleOnClick = (el, onClick) => {
                if (onClick) {
                    el.onclick = async () => {
                        const formId = args.formId;
                        if (formId) {
                            const formData = {};
                            document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`).forEach(input => {
                                formData[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                            });
                            state[`form_${formId}`] = formData;
                        }
                        await executeFluxCommands(onClick);
                    };
                }
            };

            switch (command) {
                case 'heading': {
                    const headingTag = args.size && ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(args.size) ? args.size : 'h3';
                    const heading = document.createElement(headingTag);
                    heading.textContent = args.text || '';
                    applyStyle(heading, `font-bold ${args.color}`);
                    newElement.appendChild(heading);
                    break;
                }
                case 'paragraph': {
                    const p = document.createElement('p');
                    p.textContent = args.text || '';
                    applyStyle(p, args.color);
                    newElement.appendChild(p);
                    break;
                }
                case 'list': {
                    const title = document.createElement('h4');
                    title.textContent = args.title || 'List';
                    applyStyle(title, 'font-bold mb-2');
                    newElement.appendChild(title);
                    
                    const listTag = (args.listStyle === 'numbered') ? 'ol' : 'ul';
                    const list = document.createElement(listTag);
                    applyStyle(list, `space-y-1 ${args.color}`);
                    
                    if (Array.isArray(args.items)) {
                        args.items.forEach(itemText => {
                            const li = document.createElement('li');
                            li.textContent = itemText;
                            applyStyle(li, args.itemStyle);
                            list.appendChild(li);
                        });
                    }
                    newElement.appendChild(list);
                    break;
                }
                case 'button': {
                    const button = document.createElement('button');
                    button.textContent = args.text || 'Button';
                    applyStyle(button, `px-4 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition ${args.style}`);
                    handleOnClick(button, args.onClick);
                    newElement.appendChild(button);
                    break;
                }
                case 'divider': {
                    const hr = document.createElement('hr');
                    applyStyle(hr, `my-4 ${args.color || 'border-gray-300'}`);
                    newElement.appendChild(hr);
                    break;
                }
                case 'card': {
                    const card = document.createElement('div');
                    applyStyle(card, `p-4 bg-white rounded-lg shadow-md ${args.style}`);
                    const title = document.createElement('h4');
                    title.textContent = args.title || 'Card Title';
                    applyStyle(title, 'font-bold text-lg mb-2');
                    card.appendChild(title);
                    const text = document.createElement('p');
                    text.textContent = args.text || 'Card content.';
                    applyStyle(text, 'text-gray-600');
                    card.appendChild(text);
                    newElement.appendChild(card);
                    break;
                }
                case 'input': {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = args.id;
                    input.placeholder = args.placeholder || '';
                    applyStyle(input, `w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 ${args.style}`);
                    newElement.appendChild(input);
                    break;
                }
                case 'textarea': {
                    const textarea = document.createElement('textarea');
                    textarea.id = args.id;
                    textarea.placeholder = args.placeholder || '';
                    applyStyle(textarea, `w-full h-24 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 ${args.style}`);
                    newElement.appendChild(textarea);
                    break;
                }
                case 'progress': {
                    const label = document.createElement('label');
                    label.textContent = args.label || 'Progress';
                    label.htmlFor = args.id;
                    applyStyle(label, 'block mb-1 text-sm font-medium text-gray-700');
                    newElement.appendChild(label);
                    
                    const progressContainer = document.createElement('div');
                    applyStyle(progressContainer, 'w-full bg-gray-200 rounded-full h-2.5');
                    
                    const progressBar = document.createElement('div');
                    const progressValue = args.value || 0;
                    const progressMax = args.max || 100;
                    const width = (progressValue / progressMax) * 100;
                    applyStyle(progressBar, `bg-indigo-600 h-2.5 rounded-full transition-all duration-500`);
                    progressBar.style.width = `${width}%`;
                    
                    progressContainer.appendChild(progressBar);
                    newElement.appendChild(progressContainer);
                    break;
                }
                case 'link': {
                    const a = document.createElement('a');
                    a.textContent = args.text || 'Link';
                    a.href = args.url || '#';
                    a.target = '_blank';
                    applyStyle(a, 'text-indigo-600 hover:underline');
                    newElement.appendChild(a);
                    break;
                }
                case 'iframe': {
                    showIframeView(args.url);
                    return;
                }
                case 'iframe.html': {
                    showIframeView(null, args.content);
                    return;
                }
                case 'table': {
                    const table = document.createElement('table');
                    applyStyle(table, 'min-w-full divide-y divide-gray-200 shadow-lg rounded-lg overflow-hidden');
                    const thead = document.createElement('thead');
                    applyStyle(thead, 'bg-gray-50');
                    const headerRow = document.createElement('tr');
                    (args.headers || []).forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        applyStyle(th, 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider');
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    
                    const tbody = document.createElement('tbody');
                    applyStyle(tbody, 'bg-white divide-y divide-gray-200');
                    (args.rows || []).forEach(rowArray => {
                        const row = document.createElement('tr');
                        rowArray.forEach(cellText => {
                            const td = document.createElement('td');
                            td.textContent = cellText;
                            applyStyle(td, 'px-6 py-4 whitespace-nowrap text-sm text-gray-900');
                            row.appendChild(td);
                        });
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);
                    newElement.appendChild(table);
                    break;
                }
                case 'carousel': {
                    const carouselContainer = document.createElement('div');
                    carouselContainer.className = 'carousel-container';

                    const slidesContainer = document.createElement('div');
                    slidesContainer.className = 'carousel-slides';
                    carouselContainer.appendChild(slidesContainer);

                    (args.images || []).forEach((imageUrl, index) => {
                        const slide = document.createElement('div');
                        slide.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = `Slide ${index + 1}`;
                        img.onerror = () => {
                            img.src = `https://placehold.co/600x400/1e293b/e2e8f0?text=Image+Load+Error`;
                        };
                        slide.appendChild(img);
                        slidesContainer.appendChild(slide);
                    });

                    if ((args.images || []).length > 1) {
                        const prevBtn = document.createElement('button');
                        prevBtn.textContent = '❮';
                        prevBtn.className = 'carousel-btn carousel-prev';
                        prevBtn.onclick = () => {
                            let currentSlide = carouselContainer.querySelector('.carousel-slide.active');
                            let prevSlide = currentSlide.previousElementSibling || slidesContainer.lastElementChild;
                            currentSlide.classList.remove('active');
                            prevSlide.classList.add('active');
                        };

                        const nextBtn = document.createElement('button');
                        nextBtn.textContent = '❯';
                        nextBtn.className = 'carousel-btn carousel-next';
                        nextBtn.onclick = () => {
                            let currentSlide = carouselContainer.querySelector('.carousel-slide.active');
                            let nextSlide = currentSlide.nextElementSibling || slidesContainer.firstElementChild;
                            currentSlide.classList.remove('active');
                            nextSlide.classList.add('active');
                        };
                        carouselContainer.appendChild(prevBtn);
                        carouselContainer.appendChild(nextBtn);
                    }
                    newElement.appendChild(carouselContainer);
                    break;
                }
                case 'chart': {
                    const chartContainer = document.createElement('div');
                    applyStyle(chartContainer, 'chart-container');
                    const canvas = document.createElement('canvas');
                    const chartId = args.id || `chart-${Date.now()}`;
                    canvas.id = chartId;
                    chartContainer.appendChild(canvas);
                    newElement.appendChild(chartContainer);
                    
                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: args.type,
                        data: {
                            labels: args.labels || [],
                            datasets: [{
                                label: args.title || 'Chart',
                                data: args.data || [],
                                backgroundColor: [
                                    'rgba(79, 70, 229, 0.5)',
                                    'rgba(129, 140, 248, 0.5)',
                                    'rgba(244, 63, 94, 0.5)',
                                    'rgba(16, 185, 129, 0.5)',
                                ],
                                borderColor: [
                                    'rgba(79, 70, 229, 1)',
                                    'rgba(129, 140, 248, 1)',
                                    'rgba(244, 63, 94, 1)',
                                    'rgba(16, 185, 129, 1)',
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                },
                                title: {
                                    display: !!args.title,
                                    text: args.title,
                                }
                            },
                        }
                    });
                    break;
                }
                case 'form': {
                    const form = document.createElement('div');
                    form.id = args.id;
                    applyStyle(form, `p-4 border border-gray-200 rounded-lg space-y-4 ${args.style}`);
                    newElement.appendChild(form);
                    // Commands following a form command will be rendered inside this form.
                    targetElement = form;
                    break;
                }
                case 'submit': {
                    const button = document.createElement('button');
                    button.textContent = args.text || 'Submit';
                    applyStyle(button, `px-4 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition ${args.style}`);
                    handleOnClick(button, args.onClick);
                    newElement.appendChild(button);
                    break;
                }
                case 'image': {
                    const img = document.createElement('img');
                    img.src = args.src;
                    img.alt = args.alt || '';
                    if (args.width) img.style.width = args.width;
                    if (args.height) img.style.height = args.height;
                    applyStyle(img, `rounded-lg ${args.style}`);
                    img.onerror = () => {
                         img.src = `https://placehold.co/${img.width || 400}x${img.height || 300}/1e293b/e2e8f0?text=Image+Load+Error`;
                    };
                    newElement.appendChild(img);
                    break;
                }
                case 'video': {
                    const video = document.createElement('video');
                    video.src = args.src;
                    video.controls = args.controls === 'true';
                    video.autoplay = args.autoplay === 'true';
                    video.loop = args.loop === 'true';
                    video.muted = args.muted === 'true';
                    if (args.width) video.style.width = args.width;
                    if (args.height) video.style.height = args.height;
                    applyStyle(video, `rounded-lg ${args.style}`);
                    newElement.appendChild(video);
                    break;
                }
                case 'audio': {
                    const audio = document.createElement('audio');
                    audio.src = args.src;
                    audio.controls = args.controls === 'true';
                    audio.autoplay = args.autoplay === 'true';
                    audio.loop = args.loop === 'true';
                    audio.muted = args.muted === 'true';
                    applyStyle(audio, `rounded-lg ${args.style}`);
                    newElement.appendChild(audio);
                    break;
                }
                case 'codeblock': {
                    const pre = document.createElement('pre');
                    applyStyle(pre, `bg-gray-800 text-white p-4 rounded-lg overflow-x-auto ${args.style}`);
                    const code = document.createElement('code');
                    code.textContent = args.code;
                    code.className = `language-${args.lang || 'plaintext'}`;
                    pre.appendChild(code);
                    newElement.appendChild(pre);
                    break;
                }
                case 'grid': {
                    const grid = document.createElement('div');
                    applyStyle(grid, `grid grid-cols-${args.columns || 2} gap-${args.gap || 4} ${args.style}`);
                    newElement.appendChild(grid);
                    targetElement = grid;
                    break;
                }
                case 'flex': {
                    const flex = document.createElement('div');
                    applyStyle(flex, `flex flex-${args.direction || 'row'} justify-${args.justify || 'start'} items-${args.align || 'start'} ${args.style}`);
                    newElement.appendChild(flex);
                    targetElement = flex;
                    break;
                }
                case 'accordion': {
                    const accordion = document.createElement('div');
                    applyStyle(accordion, `accordion-item border border-gray-200 rounded-lg overflow-hidden my-2`);
                    const header = document.createElement('div');
                    applyStyle(header, `accordion-header`);
                    const title = document.createElement('h4');
                    applyStyle(title, `font-medium`);
                    title.textContent = args.title || 'Accordion Title';
                    const icon = document.createElement('span');
                    applyStyle(icon, `accordion-icon`);
                    icon.textContent = '>';
                    header.appendChild(title);
                    header.appendChild(icon);
                    
                    const content = document.createElement('div');
                    applyStyle(content, `accordion-content`);
                    content.innerHTML = args.content || 'Accordion Content';
                    
                    header.onclick = () => {
                        accordion.classList.toggle('active');
                    };
                    
                    accordion.appendChild(header);
                    accordion.appendChild(content);
                    newElement.appendChild(accordion);
                    break;
                }
                case 'tabs': {
                    const tabsContainer = document.createElement('div');
                    tabsContainer.id = args.id;
                    applyStyle(tabsContainer, `w-full my-4`);

                    const tabButtonsContainer = document.createElement('div');
                    applyStyle(tabButtonsContainer, `tab-buttons`);
                    
                    const tabContentContainer = document.createElement('div');
                    applyStyle(tabContentContainer, `tab-content`);

                    const tabs = args.tabs || [];
                    const content = args.content || [];

                    tabs.forEach((tabText, index) => {
                        const button = document.createElement('button');
                        applyStyle(button, `tab-button ${index === 0 ? 'active' : ''}`);
                        button.textContent = tabText;
                        button.onclick = () => {
                            tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                            tabsContainer.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                            button.classList.add('active');
                            tabsContainer.querySelector(`#${args.id}-pane-${index}`).classList.add('active');
                        };
                        tabButtonsContainer.appendChild(button);

                        const pane = document.createElement('div');
                        pane.id = `${args.id}-pane-${index}`;
                        applyStyle(pane, `tab-pane ${index === 0 ? 'active' : ''}`);
                        pane.innerHTML = content[index] || '';
                        tabContentContainer.appendChild(pane);
                    });

                    tabsContainer.appendChild(tabButtonsContainer);
                    tabsContainer.appendChild(tabContentContainer);
                    newElement.appendChild(tabsContainer);
                    break;
                }
                case 'rating': {
                    const ratingContainer = document.createElement('div');
                    applyStyle(ratingContainer, `flex items-center space-x-1 ${args.style}`);
                    const value = Math.max(0, Math.min(args.value || 0, args.max || 5));
                    const max = args.max || 5;
                    const size = args.size || '24px';
                    const color = args.color || 'text-yellow-400';
                    
                    for (let i = 1; i <= max; i++) {
                        const star = document.createElement('span');
                        star.innerHTML = (i <= value) ? '★' : '☆';
                        star.style.fontSize = size;
                        applyStyle(star, `${color}`);
                        ratingContainer.appendChild(star);
                    }
                    newElement.appendChild(ratingContainer);
                    break;
                }
                case 'slider': {
                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.id = args.id;
                    slider.min = args.min || 0;
                    slider.max = args.max || 100;
                    slider.value = args.value || 0;
                    slider.step = args.step || 1;
                    applyStyle(slider, `w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer ${args.style}`);
                    newElement.appendChild(slider);
                    break;
                }
                case 'date-picker': {
                    const label = document.createElement('label');
                    label.textContent = args.label || '';
                    label.htmlFor = args.id;
                    applyStyle(label, 'block text-sm font-medium text-gray-700');
                    newElement.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.id = args.id;
                    input.value = args.value || '';
                    applyStyle(input, `mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 ${args.style}`);
                    newElement.appendChild(input);
                    break;
                }
                case 'time-picker': {
                    const label = document.createElement('label');
                    label.textContent = args.label || '';
                    label.htmlFor = args.id;
                    applyStyle(label, 'block text-sm font-medium text-gray-700');
                    newElement.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = 'time';
                    input.id = args.id;
                    input.value = args.value || '';
                    applyStyle(input, `mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 ${args.style}`);
                    newElement.appendChild(input);
                    break;
                }
                case 'color-picker': {
                    const label = document.createElement('label');
                    label.textContent = args.label || '';
                    label.htmlFor = args.id;
                    applyStyle(label, 'block text-sm font-medium text-gray-700');
                    newElement.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = 'color';
                    input.id = args.id;
                    input.value = args.value || '#000000';
                    applyStyle(input, `mt-1 block w-10 h-10 rounded-md border-gray-300 shadow-sm ${args.style}`);
                    newElement.appendChild(input);
                    break;
                }
                case 'qr-code': {
                    const size = args.size || 128;
                    const colorDark = args.color || '#000000';
                    const colorLight = args.background || '#ffffff';
                    const qrDiv = document.createElement('div');
                    qrDiv.id = `qrcode-${args.id || Date.now()}`;
                    newElement.appendChild(qrDiv);
                    
                    setTimeout(() => { // Ensure the div is in the DOM before creating the QR code
                        new QRCode(qrDiv.id, {
                            text: args.text || 'https://example.com',
                            width: size,
                            height: size,
                            colorDark: colorDark,
                            colorLight: colorLight,
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }, 0);
                    break;
                }
                case 'map': {
                    const iframe = document.createElement('iframe');
                    const zoom = args.zoom || 15;
                    const query = encodeURIComponent(args.query || 'London, UK');
                    iframe.src = `https://maps.google.com/maps?q=${query}&z=${zoom}&output=embed`;
                    iframe.width = args.width || '100%';
                    iframe.height = args.height || '300px';
                    iframe.frameBorder = '0';
                    iframe.allowfullscreen = '';
                    applyStyle(iframe, `rounded-lg ${args.style}`);
                    newElement.appendChild(iframe);
                    break;
                }
                case 'toast': {
                    showToast(args.message, args.type, args.duration);
                    return;
                }
                case 'spinner': {
                    const spinner = document.createElement('div');
                    const size = args.size || '32px';
                    const color = args.color || 'border-indigo-600';
                    spinner.style.width = size;
                    spinner.style.height = size;
                    applyStyle(spinner, `spinner ${color}`);
                    newElement.appendChild(spinner);
                    break;
                }
                case 'badge': {
                    const badge = document.createElement('span');
                    badge.textContent = args.text || '';
                    applyStyle(badge, `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${args.color}-100 text-${args.color}-800`);
                    newElement.appendChild(badge);
                    break;
                }
                case 'circular-progress': {
                    const size = args.size || 100;
                    const value = args.value || 0;
                    const max = args.max || 100;
                    const color = args.color || 'stroke-indigo-600';
                    
                    const progressContainer = document.createElement('div');
                    applyStyle(progressContainer, 'circular-progress');
                    progressContainer.style.width = `${size}px`;
                    progressContainer.style.height = `${size}px`;
                    
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute('width', size);
                    svg.setAttribute('height', size);
                    svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
                    
                    const backgroundCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    backgroundCircle.setAttribute('cx', size / 2);
                    backgroundCircle.setAttribute('cy', size / 2);
                    backgroundCircle.setAttribute('r', size / 2.5);
                    applyStyle(backgroundCircle, 'stroke-gray-300 fill-transparent stroke-[10]');
                    
                    const progressCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    progressCircle.setAttribute('cx', size / 2);
                    progressCircle.setAttribute('cy', size / 2);
                    progressCircle.setAttribute('r', size / 2.5);
                    const circumference = 2 * Math.PI * (size / 2.5);
                    const progress = (value / max) * circumference;
                    progressCircle.style.strokeDasharray = circumference;
                    progressCircle.style.strokeDashoffset = circumference - progress;
                    applyStyle(progressCircle, `${color} fill-transparent stroke-[10]`);
                    
                    svg.appendChild(backgroundCircle);
                    svg.appendChild(progressCircle);
                    
                    const label = document.createElement('span');
                    label.textContent = `${value}/${max}`;
                    applyStyle(label, 'text-lg font-bold');
                    
                    progressContainer.appendChild(svg);
                    progressContainer.appendChild(label);
                    newElement.appendChild(progressContainer);
                    break;
                }
                case 'toggle': {
                    const toggleContainer = document.createElement('label');
                    applyStyle(toggleContainer, `flex items-center space-x-2 cursor-pointer`);
                    
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = args.id;
                    input.checked = (state[args.id] === true);
                    applyStyle(input, `sr-only peer`);

                    const toggleSwitch = document.createElement('div');
                    applyStyle(toggleSwitch, `relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600`);
                    
                    const label = document.createElement('span');
                    label.textContent = args.label || '';
                    applyStyle(label, `text-sm font-medium text-gray-700`);

                    input.onchange = () => {
                        state[args.id] = input.checked;
                        console.log(`State for '${args.id}' changed to:`, state[args.id]);
                    };
                    
                    toggleContainer.appendChild(input);
                    toggleContainer.appendChild(toggleSwitch);
                    toggleContainer.appendChild(label);
                    newElement.appendChild(toggleContainer);
                    break;
                }
                case 'radio-group': {
                    const radioGroupContainer = document.createElement('div');
                    applyStyle(radioGroupContainer, `space-y-2`);
                    (args.options || []).forEach(option => {
                        const label = document.createElement('label');
                        applyStyle(label, `inline-flex items-center`);
                        
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = args.name;
                        input.value = option;
                        applyStyle(input, `form-radio h-4 w-4 text-indigo-600 transition duration-150 ease-in-out`);
                        
                        const span = document.createElement('span');
                        span.textContent = option;
                        applyStyle(span, `ml-2 text-gray-700`);
                        
                        label.appendChild(input);
                        label.appendChild(span);
                        radioGroupContainer.appendChild(label);
                    });
                    newElement.appendChild(radioGroupContainer);
                    break;
                }
                case 'checkbox-group': {
                    const checkboxGroupContainer = document.createElement('div');
                    applyStyle(checkboxGroupContainer, `space-y-2`);
                    (args.options || []).forEach(option => {
                        const label = document.createElement('label');
                        applyStyle(label, `inline-flex items-center`);
                        
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.name = args.name;
                        input.value = option;
                        applyStyle(input, `form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out`);
                        
                        const span = document.createElement('span');
                        span.textContent = option;
                        applyStyle(span, `ml-2 text-gray-700`);
                        
                        label.appendChild(input);
                        label.appendChild(span);
                        checkboxGroupContainer.appendChild(label);
                    });
                    newElement.appendChild(checkboxGroupContainer);
                    break;
                }
                case 'dropdown': {
                    const label = document.createElement('label');
                    label.textContent = args.label || '';
                    label.htmlFor = args.id;
                    applyStyle(label, 'block text-sm font-medium text-gray-700');
                    newElement.appendChild(label);
                    
                    const select = document.createElement('select');
                    select.id = args.id;
                    applyStyle(select, `mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md ${args.style}`);
                    
                    (args.options || []).forEach(optionText => {
                        const option = document.createElement('option');
                        option.textContent = optionText;
                        option.value = optionText;
                        select.appendChild(option);
                    });
                    newElement.appendChild(select);
                    break;
                }
                case 'modal': {
                    const modalOverlay = document.createElement('div');
                    modalOverlay.id = args.id;
                    applyStyle(modalOverlay, `flux-modal-overlay hidden`);
                    
                    const modalContent = document.createElement('div');
                    applyStyle(modalContent, `flux-modal-content`);
                    
                    const title = document.createElement('h3');
                    title.textContent = args.title || 'Modal Title';
                    applyStyle(title, `text-xl font-bold mb-2`);
                    
                    const text = document.createElement('p');
                    text.innerHTML = args.text || 'Modal content.';
                    applyStyle(text, `text-gray-600`);
                    
                    const closeButton = document.createElement('button');
                    closeButton.textContent = 'Close';
                    applyStyle(closeButton, `mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition`);
                    closeButton.onclick = () => {
                        modalOverlay.classList.add('hidden');
                    };
                    
                    modalContent.appendChild(title);
                    modalContent.appendChild(text);
                    modalContent.appendChild(closeButton);
                    modalOverlay.appendChild(modalContent);
                    document.body.appendChild(modalOverlay);
                    return; // Don't append to the output container
                }
                case 'button.modal': {
                    const button = document.createElement('button');
                    button.textContent = args.text || 'Open Modal';
                    applyStyle(button, `px-4 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition ${args.style}`);
                    button.onclick = () => {
                        const modal = document.getElementById(args.modalId);
                        if (modal) {
                            modal.classList.remove('hidden');
                        } else {
                            showToast(`Modal with ID '${args.modalId}' not found.`, 'error');
                        }
                    };
                    newElement.appendChild(button);
                    break;
                }
                default: {
                    showToast(`Unknown command: ${command}`, 'error');
                    break;
                }
            }

            // Append to the correct parent element
            (targetElement || dynamicOutputContainer).appendChild(newElement);
            return newElement; // Return the new element for nested commands
        };

        const parseFluxCode = (code) => {
            const lines = code.split('\n').map(line => line.trim()).filter(line => line.length > 0 && !line.startsWith('//'));
            const commands = [];
            let currentParent = null;

            lines.forEach(line => {
                const match = line.match(/^([a-zA-Z0-9\.-]+):\s*(.*)/);
                if (!match) {
                    return;
                }
                const command = match[1];
                const paramsString = match[2];

                const args = {};
                const regex = /(\w+)=(".*?"|'.*?'|\[.*?\]|\{.*?\}|\S+)/g;
                let paramMatch;
                while ((paramMatch = regex.exec(paramsString)) !== null) {
                    const key = paramMatch[1];
                    let value = paramMatch[2];
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    } else if (value.startsWith("'") && value.endsWith("'")) {
                        value = value.slice(1, -1);
                    } else if (value.startsWith('[') && value.endsWith(']')) {
                        try {
                            value = JSON.parse(value);
                        } catch (e) {
                            value = [];
                        }
                    } else if (value.startsWith('{') && value.endsWith('}')) {
                        try {
                            value = JSON.parse(value);
                        } catch (e) {
                            value = {};
                        }
                    } else if (value.toLowerCase() === 'true') {
                        value = true;
                    } else if (value.toLowerCase() === 'false') {
                        value = false;
                    } else if (!isNaN(Number(value))) {
                        value = Number(value);
                    }
                    args[key] = value;
                }
                
                commands.push({ command, args, parent: currentParent });

                // Handle nested commands for form and grid/flex
                if (['form', 'grid', 'flex'].includes(command)) {
                    currentParent = commands.at(-1);
                } else if (line.endsWith('end') && currentParent) {
                    currentParent = null;
                }
            });
            return commands;
        };

        const executeFluxCommands = async (code, targetElement = dynamicOutputContainer) => {
            const commands = parseFluxCode(code);
            if (commands.length === 0) return;

            const commandQueue = [...commands];
            let currentContext = { targetElement };

            while (commandQueue.length > 0) {
                const cmd = commandQueue.shift();
                const { command, args } = cmd;

                if (['form', 'grid', 'flex'].includes(command)) {
                    const newElement = renderElement(command, args, currentContext.targetElement);
                    currentContext.targetElement = newElement.lastElementChild || newElement;
                    continue;
                }
                if (['end'].includes(command)) {
                    currentContext.targetElement = dynamicOutputContainer;
                    continue;
                }

                switch (command) {
                    case 'show':
                        document.getElementById(args.id)?.classList.remove('hidden');
                        break;
                    case 'hide':
                        document.getElementById(args.id)?.classList.add('hidden');
                        break;
                    case 'wait':
                        await wait(args.seconds || 1);
                        break;
                    case 'alert':
                        showCustomAlert(args.text);
                        break;
                    case 'set':
                        state[args.key] = args.value;
                        console.log(`State key '${args.key}' set to:`, state[args.key]);
                        break;
                    case 'get':
                        const element = document.getElementById(args.targetId);
                        if (element && state.hasOwnProperty(args.key)) {
                            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                                element.value = state[args.key];
                            } else {
                                element.textContent = state[args.key];
                            }
                        }
                        break;
                    case 'get.input':
                        const inputElement = document.getElementById(args.id);
                        if (inputElement) {
                            state[args.key] = inputElement.value;
                            console.log(`State key '${args.key}' updated from input:`, state[args.key]);
                        }
                        break;
                    case 'if':
                        const conditionResult = safeEvaluateCondition(args.condition);
                        if (conditionResult) {
                            if (args.then) {
                                await executeFluxCommands(args.then, currentContext.targetElement);
                            }
                        } else {
                            if (args.else) {
                                await executeFluxCommands(args.else, currentContext.targetElement);
                            }
                        }
                        break;
                    case 'for':
                        const collection = state[args.collection];
                        if (Array.isArray(collection)) {
                            for (const item of collection) {
                                // Create a temporary state for the loop item
                                const tempState = { ...state, [args.as]: item };
                                const originalState = { ...state }; // Backup original state
                                Object.assign(state, tempState); // Merge temp state

                                await executeFluxCommands(args.do, currentContext.targetElement);
                                Object.assign(state, originalState); // Restore original state
                            }
                        }
                        break;
                    case 'firebase.set':
                    case 'firebase.update':
                        if (window.db && window.userId) {
                            try {
                                const data = JSON.parse(args.data);
                                const docPath = `artifacts/${window.appId}/users/${window.userId}/${args.path}`;
                                if (command === 'firebase.set') {
                                    await setDoc(doc(window.db, docPath), data, { merge: true });
                                    showToast(`Data set at path: ${docPath}`, 'success');
                                } else {
                                    await updateDoc(doc(window.db, docPath), data);
                                    showToast(`Data updated at path: ${docPath}`, 'success');
                                }
                            } catch (e) {
                                showToast(`Error saving to Firebase: ${e.message}`, 'error');
                            }
                        } else {
                            showToast('Firebase not initialized or user not signed in.', 'error');
                        }
                        break;
                    case 'firebase.get':
                        if (window.db && window.userId) {
                            try {
                                const docPath = `artifacts/${window.appId}/users/${window.userId}/${args.path}`;
                                const docSnap = await getDoc(doc(window.db, docPath));
                                if (docSnap.exists()) {
                                    state[args.key] = docSnap.data();
                                    showToast(`Data retrieved for key '${args.key}'`, 'success');
                                    renderFluxApp(); // Re-render the app to reflect the new state
                                } else {
                                    showToast(`No document found at path: ${docPath}`, 'warning');
                                }
                            } catch (e) {
                                showToast(`Error retrieving from Firebase: ${e.message}`, 'error');
                            }
                        } else {
                            showToast('Firebase not initialized or user not signed in.', 'error');
                        }
                        break;
                    case 'firebase.delete':
                        if (window.db && window.userId) {
                            try {
                                const docPath = `artifacts/${window.appId}/users/${window.userId}/${args.path}`;
                                await deleteDoc(doc(window.db, docPath));
                                showToast(`Document deleted at path: ${docPath}`, 'success');
                            } catch (e) {
                                showToast(`Error deleting document: ${e.message}`, 'error');
                            }
                        } else {
                            showToast('Firebase not initialized or user not signed in.', 'error');
                        }
                        break;
                    case 'firebase.listen':
                        if (window.db && window.userId) {
                            try {
                                const docPath = `artifacts/${window.appId}/users/${window.userId}/${args.path}`;
                                onSnapshot(doc(window.db, docPath), (doc) => {
                                    if (doc.exists()) {
                                        state[args.key] = doc.data();
                                        showToast(`Real-time update for key '${args.key}'`, 'info');
                                        renderFluxApp();
                                    } else {
                                        console.log("No such document!");
                                    }
                                });
                            } catch (e) {
                                showToast(`Error setting up listener: ${e.message}`, 'error');
                            }
                        } else {
                            showToast('Firebase not initialized or user not signed in.', 'error');
                        }
                        break;
                    default:
                        renderElement(command, args, currentContext.targetElement);
                        break;
                }
            }
        };

        const renderFluxApp = async () => {
            if (window.userId) {
                errorContainer.classList.add('hidden');
                outputContainer.innerHTML = ''; // Clear all previous content
                showMainAppView();
                const newDynamicOutputContainer = document.createElement('div');
                newDynamicOutputContainer.id = 'dynamic-output';
                outputContainer.appendChild(newDynamicOutputContainer);
                const fluxCode = editor.value;
                await executeFluxCommands(fluxCode, newDynamicOutputContainer);
            } else {
                errorText.textContent = "Please wait for user authentication to complete...";
                errorContainer.classList.remove('hidden');
            }
        };

        // Event listener for editor changes
        editor.addEventListener('input', () => {
            renderFluxApp();
        });

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if Firebase is already initialized, if not, the onAuthStateChanged listener will call renderFluxApp later.
            if (window.auth && window.auth.currentUser) {
                renderFluxApp();
            }
        });
    </script>
</body>
</html>
