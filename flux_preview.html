<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for powerful data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- qrcode.js CDN for functional QR code generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!--
        Removed Firebase SDKs and initialization from the main script.
        The app will no longer automatically authenticate a user.
        You can add Firebase back manually as needed.
    -->
    <style>
        /* General styling for a nice, clean look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Style for the custom modal dialog */
        .custom-alert-overlay, .custom-confirm-overlay, .custom-prompt-overlay, .flux-modal-overlay, .toast-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .custom-alert-box, .custom-confirm-box, .custom-prompt-box, .flux-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            min-width: 300px;
            text-align: center;
            max-height: 80vh; /* Set a max height for the modal */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        
        /* Carousel-specific styles */
        .carousel-container {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .carousel-slides {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }

        .carousel-slide {
            min-width: 100%;
            flex-shrink: 0;
            display: none; /* Hide all slides by default */
        }
        .carousel-slide.active {
            display: block;
        }

        .carousel-slide img {
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            padding: 1rem;
            z-index: 10;
            transition: background-color 0.3s;
        }
        .carousel-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .carousel-prev {
            left: 0;
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .carousel-next {
            right: 0;
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        /* Iframe-specific styles */
        #iframe-view-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #iframe-container {
            flex-grow: 1;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Chart container styles */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
            margin-top: 1rem;
        }

        /* Circular progress styling */
        .circular-progress {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circular-progress svg {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotate(-90deg);
        }
        .circular-progress svg circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        
        /* Modal styling */
        .flux-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .flux-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 500px;
            min-width: 300px;
            text-align: center;
        }

        /* Styling for the new single-textarea editor */
        #flux-editor {
            width: 100%;
            height: 100%;
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0;
            padding: 1rem;
            border: none;
            background-color: white; /* Changed to white */
            color: #1f2937; /* Changed to dark gray for readability */
            white-space: pre;
            word-wrap: normal;
            resize: none;
            outline: none;
            font-family: 'Fira Code', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
        }
        #flux-editor::placeholder {
            color: #6b7280; /* Darker placeholder text for visibility on white background */
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
            pointer-events: none; /* Allows clicks to pass through */
            background-color: transparent; /* Overlay should be transparent */
        }
        .toast-item {
            background-color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: #333;
            font-size: 0.875rem;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOut 4s forwards;
            pointer-events: auto; /* Re-enable pointer events for the toast itself */
        }
        .toast-item.success { border-left: 5px solid #10B981; } /* Green */
        .toast-item.error { border-left: 5px solid #EF4444; }    /* Red */
        .toast-item.info { border-left: 5px solid #3B82F6; }    /* Blue */
        .toast-item.warning { border-left: 5px solid #F59E0B; } /* Yellow */

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #333; /* Default color, can be overridden */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Accordion */
        .accordion-header {
            cursor: pointer;
            padding: 1rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-content {
            padding: 1rem;
            background-color: #ffffff;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out;
        }
        .accordion-item.active .accordion-content {
            max-height: 500px; /* Adjust as needed */
            transition: max-height 0.5s ease-in;
        }
        .accordion-icon {
            transition: transform 0.3s ease-out;
        }
        .accordion-item.active .accordion-icon {
            transform: rotate(90deg);
        }

        /* Tabs */
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-button {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-weight: 500;
            color: #6b7280;
            transition: color 0.3s, border-color 0.3s;
        }
        .tab-button.active {
            color: #4F46E5;
            border-bottom: 2px solid #4F46E5;
        }
        .tab-content {
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Main Container -->
    <div class="min-h-screen flex flex-col lg:flex-row items-start justify-center p-4 gap-4">

        <!-- Code Editor and Interpreter Input -->
        <div id="main-app-container" class="w-full lg:w-1/2 p-4 bg-white rounded-xl shadow-2xl flex flex-col h-[70vh] lg:h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-indigo-600">Flux Editor</h2>
                <button id="commands-list-btn" class="p-2 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            <!-- The new single textarea editor -->
            <textarea
                id="flux-editor"
                spellcheck="false"
                class="font-mono text-sm flex-grow border border-gray-300 rounded-lg"
                placeholder="Enter your Flux code here..."
            ></textarea>
            
            <div id="error-message" class="mt-4 p-3 bg-red-100 text-red-700 border border-red-400 rounded-lg font-mono text-sm hidden">
                <p id="error-message-text"></p>
            </div>
        </div>

        <!-- Rendered Output -->
        <div id="rendered-app-container" class="w-full lg:w-1/2 p-4 bg-white rounded-xl shadow-2xl flex flex-col h-auto lg:h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Rendered Flux Application</h2>
            
            <!-- Removed User ID Display since authentication is no longer active by default -->
            <!-- <p id="user-id-display" class="text-sm text-gray-500 mb-4 font-mono"></p> -->

            <!-- Standard Flux Output Container -->
            <div id="rendered-output" class="flex-grow p-4 bg-gray-50 rounded-lg">
                <div id="dynamic-output" class="hidden">
                    <!-- Dynamic content from button clicks will be appended here -->
                </div>
            </div>

            <!-- Iframe Container (Hidden by default) -->
            <div id="iframe-view-container" class="hidden">
                <div id="iframe-container" class="flex-grow"></div>
            </div>
        </div>

    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="custom-alert-overlay hidden">
      <div class="custom-alert-box">
        <p id="custom-alert-text" class="text-gray-800"></p>
        <div class="mt-4 flex justify-center space-x-4">
            <button id="custom-alert-close" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
        </div>
      </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="custom-confirm-overlay hidden">
        <div class="custom-confirm-box">
            <p id="custom-confirm-text" class="text-gray-800"></p>
            <div class="mt-4 flex justify-center space-x-4">
                <button id="custom-confirm-ok" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
                <button id="custom-confirm-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Prompt Modal -->
    <div id="custom-prompt-modal" class="custom-prompt-overlay hidden">
        <div class="custom-prompt-box">
            <p id="custom-prompt-text" class="text-gray-800"></p>
            <input type="text" id="custom-prompt-input" class="w-full h-10 px-4 mt-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter value">
            <div class="mt-4 flex justify-center space-x-4">
                <button id="custom-prompt-ok" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
                <button id="custom-prompt-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>


    <script>
        // === Custom Alert Function (Replaces alert()) ===
        const showCustomAlert = (message) => {
            const modal = document.getElementById('custom-alert-modal');
            const text = document.getElementById('custom-alert-text');
            const closeBtn = document.getElementById('custom-alert-close');
            text.innerHTML = message;
            modal.classList.remove('hidden');
            
            closeBtn.onclick = () => modal.classList.add('hidden');
        };

        // === Custom Confirm Function (Replaces confirm()) ===
        const showCustomConfirm = (message) => {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-confirm-modal');
                const text = document.getElementById('custom-confirm-text');
                const okBtn = document.getElementById('custom-confirm-ok');
                const cancelBtn = document.getElementById('custom-confirm-cancel');

                text.textContent = message;
                modal.classList.remove('hidden');

                okBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };
            });
        };

        // === Custom Prompt Function (Replaces prompt()) ===
        const showCustomPrompt = (message, placeholder = '') => {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-prompt-modal');
                const text = document.getElementById('custom-prompt-text');
                const input = document.getElementById('custom-prompt-input');
                const okBtn = document.getElementById('custom-prompt-ok');
                const cancelBtn = document.getElementById('custom-prompt-cancel');

                text.textContent = message;
                input.value = ''; // Clear previous input
                input.placeholder = placeholder;
                modal.classList.remove('hidden');

                okBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(input.value);
                };
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(null); // Return null if cancelled
                };
            });
        };

        // === Toast Notification ===
        const showToast = (message, type = 'info', duration = 3000) => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `toast-item ${type}`;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, duration);
        };

        // === State Variables (replaces React's useState) ===
        const activeModals = {};
        const state = {}; // New state object to hold dynamic values
        const fluxIntervals = {}; // To store interval IDs for polling
        const countdownTimers = {}; // To store countdown interval IDs

        // === DOM Element References ===
        const editor = document.getElementById('flux-editor');
        const outputContainer = document.getElementById('rendered-output');
        const dynamicOutputContainer = document.getElementById('dynamic-output');
        const iframeViewContainer = document.getElementById('iframe-view-container');
        const iframeContainer = document.getElementById('iframe-container');
        const errorContainer = document.getElementById('error-message');
        const errorText = document.getElementById('error-message-text');
        const commandsListBtn = document.getElementById('commands-list-btn');

        // --- New `wait` function for async rendering ---
        const wait = (seconds) => new Promise(resolve => setTimeout(resolve, seconds * 1000));

        // --- View management for Iframe ---
        const showIframeView = (url, htmlContent = null) => {
            outputContainer.classList.add('hidden');
            iframeViewContainer.classList.remove('hidden');
            const iframe = document.createElement('iframe');
            if (url) {
                iframe.src = url;
            } else if (htmlContent) {
                iframe.srcdoc = htmlContent;
            }
            iframeContainer.innerHTML = ''; // Clear previous iframe
            iframeContainer.appendChild(iframe);
        };

        const showMainAppView = () => {
            iframeViewContainer.classList.add('hidden');
            outputContainer.classList.remove('hidden');
            iframeContainer.innerHTML = '';
        };

        // --- Simple Expression Evaluator for 'if' conditions ---
        const safeEvaluateCondition = (conditionString) => {
            // Basic parsing for simple comparisons like "state.myVar == 'value'"
            // Supports: ==, !=, >, <, >=, <=
            const match = conditionString.match(/^(state\.[a-zA-Z0-9_]+)\s*(==|!=|>=|<=|>|<)\s*(.+)$/);
            if (!match) {
                console.error("Invalid condition format:", conditionString);
                return false;
            }

            let [, leftPath, operator, rightValueStr] = match;
            
            // Resolve left operand from state
            let leftValue = state;
            const pathParts = leftPath.substring(6).split('.'); // Remove 'state.'
            for (const part of pathParts) {
                if (leftValue && typeof leftValue === 'object' && leftValue.hasOwnProperty(part)) {
                    leftValue = leftValue[part];
                } else {
                    leftValue = undefined; // Path not found
                    break;
                }
            }

            // Parse right operand
            let rightValue;
            if (rightValueStr.startsWith("'") && rightValueStr.endsWith("'")) {
                rightValue = rightValueStr.slice(1, -1); // String literal
            } else if (rightValueStr.toLowerCase() === 'true') {
                rightValue = true;
            } else if (rightValueStr.toLowerCase() === 'false') {
                rightValue = false;
            } else if (!isNaN(Number(rightValueStr))) {
                rightValue = Number(rightValueStr); // Number
            } else {
                rightValue = rightValueStr; // Treat as raw string
            }

            // Perform comparison
            switch (operator) {
                case '==': return leftValue == rightValue;
                case '!=': return leftValue != rightValue;
                case '>': return leftValue > rightValue;
                case '<': return leftValue < rightValue;
                case '>=': return leftValue >= rightValue;
                case '<=': return leftValue <= rightValue;
                default: return false;
            }
        };

        // --- Commands List Function ---
        const showCommandsList = () => {
            const commandsList = `
                <h3 class="font-bold text-xl mb-4">Available Commands</h3>
                <ul class="text-left text-sm">
                    <li class="mb-2"><strong>heading:</strong> <code>text="string", size="h1|h2|h3|h4", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>paragraph:</strong> <code>text="string", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>list:</strong> <code>title="string", items=["item1", "item2"], listStyle="numbered|bulleted", itemStyle="tailwind-style-classes", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>button:</strong> <code>text="string", style="tailwind-style-classes", onClick="flux commands"</code></li>
                    <li class="mb-2"><strong>divider:</strong> <code>color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>card:</strong> <code>title="string", text="string", style="tailwind-style-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>show:</strong> <code>id="string"</code></li>
                    <li class="mb-2"><strong>hide:</strong> <code>id="string"</code></li>
                    <li class="mb-2"><strong>wait:</strong> <code>seconds="number"</code></li>
                    <li class="mb-2"><strong>input:</strong> <code>id="string", placeholder="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2"><strong>textarea:</strong> <code>id="string", placeholder="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2"><strong>alert:</strong> <code>text="string", type="success|warning|error|info"</code></li>
                    <li class="mb-2"><strong>progress:</strong> <code>label="string", value="number", max="number", id="string"</code></li>
                    <li class="mb-2"><strong>link:</strong> <code>text="string", url="string"</code> (loads URL in iframe)</li>
                    <li class="mb-2"><strong>iframe:</strong> <code>url="string"</code> (loads URL in iframe)</li>
                    <li class="mb-2"><strong>search:</strong> <code>query="string"</code></li>
                    <li class="mb-2"><strong>table:</strong> <code>headers=["Header1", "Header2"], rows=[["data1", "data2"]], id="string(optional)"</code></li>
                    <li class="mb-2"><strong>carousel:</strong> <code>images=["url1", "url2"], id="string(optional)"</code></li>
                    <li class="mb-2"><strong>chart:</strong> <code>type="bar|line|pie", labels=["label1", "label2"], data=[10, 20], title="string (optional)", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>form:</strong> <code>id="string"</code> (a container for inputs)</li>
                    <li class="mb-2"><strong>submit:</strong> <code>formId="string", text="string", onClick="flux commands"</code></li>
                    <li class="mb-2"><strong>store:</strong> <code>id="string", value="string"</code> (deprecated, use 'set')</li>
                    <li class="mb-2"><strong>load:</strong> <code>id="string"</code> (deprecated, use 'get')</li>
                    <li class="mb-2 font-bold mt-4">--- New UI Commands ---</li>
                    <li class="mb-2"><strong>image:</strong> <code>src="url", alt="text", width="px|% (optional)", height="px|% (optional)", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>video:</strong> <code>src="url", controls="true|false", autoplay="true|false", loop="true|false", muted="true|false", width="px|% (optional)", height="px|% (optional)", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>audio:</strong> <code>src="url", controls="true|false", autoplay="true|false", loop="true|false", muted="true|false", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>iframe.html:</strong> <code>content="<html content>", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>codeblock:</strong> <code>code="string", lang="javascript|html|css|python|plaintext", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>grid:</strong> <code>columns="number", gap="number", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>flex:</strong> <code>direction="row|col", justify="start|end|center|between|around|evenly", align="start|end|center|stretch|baseline", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>accordion:</strong> <code>title="string", content="string", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>tabs:</strong> <code>id="string", tabs=["Tab 1", "Tab 2"], content=["Content 1", "Content 2"]</code></li>
                    <li class="mb-2"><strong>rating:</strong> <code>value="number", max="number", size="number(px)", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>slider:</strong> <code>id="string", min="number", max="number", value="number", step="number", style="tailwind-classes"</code></li>
                    <li class="mb-2"><strong>date-picker:</strong> <code>id="string", label="string", value="YYYY-MM-DD (optional)", style="tailwind-classes"</code></li>
                    <li class="mb-2"><strong>time-picker:</strong> <code>id="string", label="string", value="HH:MM (optional)", style="tailwind-classes"</code></li>
                    <li class="mb-2"><strong>color-picker:</strong> <code>id="string", label="string", value="#RRGGBB (optional)", style="tailwind-classes"</code></li>
                    <li class="mb-2"><strong>qr-code:</strong> <code>text="string", size="number(px)", color="hex", background="hex", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>map:</strong> <code>query="location string", zoom="number", width="px|%", height="px|%", style="tailwind-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>toast:</strong> <code>message="string", type="success|error|info|warning", duration="number(ms)"</code></li>
                    <li class="mb-2"><strong>spinner:</strong> <code>size="number(px)", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>badge:</strong> <code>text="string", color="tailwind-color-class"</code></li>
                    <li class="mb-2"><strong>circular-progress:</strong> <code>value="number", max="number", size="number(px)", color="tailwind-color-class"</code></li>
                    <li class="mb-2"><strong>toggle:</strong> <code>id="string", label="string"</code></li>
                    <li class="mb-2"><strong>radio-group:</strong> <code>name="string", options=["option1", "option2"]</code></li>
                    <li class="mb-2"><strong>checkbox-group:</strong> <code>name="string", options=["option1", "option2"]</code></li>
                    <li class="mb-2"><strong>dropdown:</strong> <code>id="string", options=["option1", "option2"], label="string"</code></li>
                    <li class="mb-2"><strong>modal:</strong> <code>id="string", title="string", text="string"</code></li>
                    <li class="mb-2"><strong>button.modal:</strong> <code>text="string", modalId="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2 font-bold mt-4">--- New Logic & Data Commands ---</li>
                    <li class="mb-2"><strong>set:</strong> <code>key="string", value="string|number|boolean|array|object"</code> (stores in app state)</li>
                    <li class="mb-2"><strong>get:</strong> <code>key="string"</code> (retrieves from app state)</li>
                    <li class="mb-2"><strong>if:</strong> <code>condition="state.key == 'value'", then="flux commands", else="flux commands"</code></li>
                    <li class="mb-2"><strong>fetch:</strong> <code>url="string", method="GET|POST", body="string(optional)", headers="object(optional)", onSuccess="flux commands (binds 'result' variable)", onError="flux commands (binds 'error' variable)"</code></li>
                    <li class="mb-2"><strong>loop:</strong> <code>from="number", to="number", step="number", commands="flux commands"</code> (binds 'index' variable)</li>
                    <li class="mb-2"><strong>foreach:</strong> <code>array="array", commands="flux commands"</code> (binds 'item' and 'index' variables)</li>
                    <li class="mb-2"><strong>switch:</strong> <code>variable="string", cases="object with key-value pairs of cases and commands"</code></li>
                    <li class="mb-2"><strong>repeat:</strong> <code>count="number", commands="flux commands"</code> (binds 'index' variable)</li>
                    <li class="mb-2"><strong>interval:</strong> <code>id="string", seconds="number", commands="flux commands"</code></li>
                    <li class="mb-2"><strong>clearInterval:</strong> <code>id="string"</code></li>
                    <li class="mb-2"><strong>countdown:</strong> <code>id="string", seconds="number", onTick="flux commands", onEnd="flux commands"</code></li>
                    <li class="mb-2"><strong>stopCountdown:</strong> <code>id="string"</code></li>
                    <li class="mb-2 font-bold mt-4">--- Firebase Commands (if enabled) ---</li>
                    <li class="mb-2"><strong>firebase.setDoc:</strong> <code>collection="string", docId="string", data="object"</code></li>
                    <li class="mb-2"><strong>firebase.updateDoc:</strong> <code>collection="string", docId="string", data="object"</code></li>
                    <li class="mb-2"><strong>firebase.getDoc:</strong> <code>collection="string", docId="string", onSuccess="flux commands (binds 'doc' variable)"</code></li>
                    <li class="mb-2"><strong>firebase.deleteDoc:</strong> <code>collection="string", docId="string"</code></li>
                    <li class="mb-2"><strong>firebase.getDocs:</strong> <code>collection="string", onSuccess="flux commands (binds 'docs' variable)"</code></li>
                    <li class="mb-2"><strong>firebase.realtime:</strong> <code>collection="string", onUpdate="flux commands (binds 'docs' variable)"</code></li>
                </ul>
            `;
            const modal = document.createElement('div');
            modal.className = 'flux-modal-overlay';
            modal.innerHTML = `
                <div class="flux-modal-content">
                    <div class="flex justify-end">
                        <button class="text-gray-500 hover:text-gray-700 font-bold text-xl leading-none">&times;</button>
                    </div>
                    <div class="text-left max-h-[70vh] overflow-y-auto">
                        ${commandsList}
                    </div>
                </div>
            `;
            modal.querySelector('button').onclick = () => {
                modal.remove();
            };
            document.body.appendChild(modal);
        };
        commandsListBtn.onclick = showCommandsList;

        // --- Core Flux Parser & Renderer ---
        const renderFlux = async () => {
            dynamicOutputContainer.innerHTML = '';
            showMainAppView();
            const code = editor.value;
            const lines = code.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.startsWith('#') || line.startsWith('//')) continue;

                // Simple check for nested commands
                const firstColonIndex = line.indexOf(':');
                if (firstColonIndex === -1) {
                    continue;
                }
                const commandName = line.substring(0, firstColonIndex).trim();

                let params = {};
                try {
                    const paramsString = line.substring(firstColonIndex + 1).trim();
                    if (paramsString) {
                        // Use a safer parser for key-value pairs, ignoring complex JSON for now
                        const pairs = paramsString.match(/(?<key>[a-zA-Z0-9_.]+)\s*=\s*"(?<value>[^"]*)"|(?<key2>[a-zA-Z0-9_.]+)\s*=\s*(?<value2>\[.*?\]|\{.*?\}|true|false|\d+)/g);
                        if (pairs) {
                            pairs.forEach(pair => {
                                const [key, value] = pair.split(/=(.*)/s).map(s => s.trim());
                                // Sanitize and parse value
                                let parsedValue = value;
                                if (parsedValue.startsWith('[') && parsedValue.endsWith(']')) {
                                    try {
                                        parsedValue = JSON.parse(parsedValue.replace(/'/g, '"'));
                                    } catch (e) {
                                        console.error(`Error parsing array for key ${key}:`, e);
                                    }
                                } else if (parsedValue.startsWith('{') && parsedValue.endsWith('}')) {
                                    try {
                                        parsedValue = JSON.parse(parsedValue.replace(/'/g, '"'));
                                    } catch (e) {
                                        console.error(`Error parsing object for key ${key}:`, e);
                                    }
                                } else if (parsedValue.startsWith('"') && parsedValue.endsWith('"')) {
                                    parsedValue = parsedValue.slice(1, -1);
                                } else if (!isNaN(Number(parsedValue))) {
                                    parsedValue = Number(parsedValue);
                                } else if (parsedValue.toLowerCase() === 'true' || parsedValue.toLowerCase() === 'false') {
                                    parsedValue = parsedValue.toLowerCase() === 'true';
                                }
                                params[key.replace(/\.$/, '')] = parsedValue;
                            });
                        }
                    }
                } catch (e) {
                    console.error("Error parsing command parameters:", e);
                    showError(`Error parsing parameters for command '${commandName}' on line ${i + 1}. Check syntax.`);
                    return;
                }

                // If condition logic
                if (commandName === 'if') {
                    if (!params.condition || !params.then) {
                        showError("`if` command requires 'condition' and 'then' parameters.");
                        return;
                    }
                    const conditionMet = safeEvaluateCondition(params.condition);
                    const commandsToRun = conditionMet ? params.then : params.else;
                    if (commandsToRun) {
                        await executeFluxCommands(commandsToRun);
                    }
                    continue;
                }

                if (commandName === 'set') {
                    state[params.key] = params.value;
                    continue;
                }

                // If a command has an onClick property, it's a function, not a simple string
                if (params.onClick) {
                    const originalOnClick = params.onClick;
                    params.onClick = async () => {
                        await executeFluxCommands(originalOnClick);
                        renderFlux(); // Re-render after a button click
                    };
                }

                // Execute a single command line.
                await executeFluxCommand(commandName, params);
            }
        };

        const executeFluxCommands = async (commandString) => {
            const commands = commandString.split(';').map(cmd => cmd.trim()).filter(cmd => cmd.length > 0);
            for (const command of commands) {
                const firstColonIndex = command.indexOf(':');
                if (firstColonIndex === -1) continue;
                const commandName = command.substring(0, firstColonIndex).trim();
                let params = {};
                try {
                    const paramsString = command.substring(firstColonIndex + 1).trim();
                    if (paramsString) {
                        const pairs = paramsString.match(/(?<key>[a-zA-Z0-9_.]+)\s*=\s*"(?<value>[^"]*)"|(?<key2>[a-zA-Z0-9_.]+)\s*=\s*(?<value2>\[.*?\]|\{.*?\}|true|false|\d+)/g);
                        if (pairs) {
                            pairs.forEach(pair => {
                                const [key, value] = pair.split(/=(.*)/s).map(s => s.trim());
                                let parsedValue = value;
                                if (parsedValue.startsWith('[') && parsedValue.endsWith(']')) {
                                    try { parsedValue = JSON.parse(parsedValue.replace(/'/g, '"')); } catch (e) {}
                                } else if (parsedValue.startsWith('{') && parsedValue.endsWith('}')) {
                                    try { parsedValue = JSON.parse(parsedValue.replace(/'/g, '"')); } catch (e) {}
                                } else if (parsedValue.startsWith('"') && parsedValue.endsWith('"')) {
                                    parsedValue = parsedValue.slice(1, -1);
                                } else if (!isNaN(Number(parsedValue))) {
                                    parsedValue = Number(parsedValue);
                                } else if (parsedValue.toLowerCase() === 'true' || parsedValue.toLowerCase() === 'false') {
                                    parsedValue = parsedValue.toLowerCase() === 'true';
                                }
                                params[key.replace(/\.$/, '')] = parsedValue;
                            });
                        }
                    }
                } catch (e) {
                    console.error("Error parsing nested command parameters:", e);
                    showError(`Error parsing parameters for nested command '${commandName}'.`);
                    return;
                }
                
                // If condition logic for nested commands
                if (commandName === 'if') {
                    if (!params.condition || !params.then) {
                        showError("`if` command requires 'condition' and 'then' parameters.");
                        return;
                    }
                    const conditionMet = safeEvaluateCondition(params.condition);
                    const commandsToRun = conditionMet ? params.then : params.else;
                    if (commandsToRun) {
                        await executeFluxCommands(commandsToRun);
                    }
                    continue;
                }
                
                await executeFluxCommand(commandName, params);
            }
        };

        const executeFluxCommand = async (commandName, params) => {
            const outputArea = dynamicOutputContainer;

            // Resolve values from state
            const resolveValue = (val) => {
                if (typeof val === 'string' && val.startsWith('state.')) {
                    const path = val.substring(6);
                    let resolved = state;
                    try {
                        const pathParts = path.split('.');
                        for (const part of pathParts) {
                            resolved = resolved[part];
                            if (resolved === undefined) break;
                        }
                    } catch (e) {
                        resolved = undefined;
                    }
                    return resolved;
                }
                return val;
            };

            // Recursively resolve values in arrays and objects
            const resolveParams = (obj) => {
                if (Array.isArray(obj)) {
                    return obj.map(item => resolveValue(item));
                }
                if (typeof obj === 'object' && obj !== null) {
                    const newObj = {};
                    for (const key in obj) {
                        newObj[key] = resolveValue(obj[key]);
                    }
                    return newObj;
                }
                return resolveValue(obj);
            };

            params = resolveParams(params);

            // Command switch statement
            switch (commandName) {
                case 'heading': {
                    const element = document.createElement(params.size || 'h2');
                    element.textContent = params.text;
                    element.className = `${params.color || 'text-gray-800'} font-bold mt-4`;
                    if (params.id) element.id = params.id;
                    outputArea.appendChild(element);
                    break;
                }
                case 'paragraph': {
                    const element = document.createElement('p');
                    element.textContent = params.text;
                    element.className = `${params.color || 'text-gray-700'} mt-2`;
                    if (params.id) element.id = params.id;
                    outputArea.appendChild(element);
                    break;
                }
                case 'list': {
                    const listContainer = document.createElement('div');
                    if (params.id) listContainer.id = params.id;
                    if (params.title) {
                        const titleEl = document.createElement('h4');
                        titleEl.textContent = params.title;
                        titleEl.className = `${params.color || 'text-gray-800'} font-semibold mt-4`;
                        listContainer.appendChild(titleEl);
                    }
                    const listElement = document.createElement(params.listStyle === 'numbered' ? 'ol' : 'ul');
                    listElement.className = `list-${params.listStyle === 'numbered' ? 'decimal' : 'disc'} list-inside mt-2 text-gray-700`;
                    if (params.items && Array.isArray(params.items)) {
                        params.items.forEach(itemText => {
                            const listItem = document.createElement('li');
                            listItem.textContent = itemText;
                            if (params.itemStyle) listItem.className = params.itemStyle;
                            listElement.appendChild(listItem);
                        });
                    }
                    listContainer.appendChild(listElement);
                    outputArea.appendChild(listContainer);
                    break;
                }
                case 'button': {
                    const element = document.createElement('button');
                    element.textContent = params.text;
                    element.className = `bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition ${params.style}`;
                    if (params.onClick) element.onclick = params.onClick;
                    outputArea.appendChild(element);
                    break;
                }
                case 'divider': {
                    const element = document.createElement('hr');
                    element.className = `my-4 border-t-2 border-${params.color || 'gray-200'}`;
                    if (params.id) element.id = params.id;
                    outputArea.appendChild(element);
                    break;
                }
                case 'card': {
                    const element = document.createElement('div');
                    element.className = `bg-white p-6 rounded-xl shadow-lg mt-4 ${params.style}`;
                    if (params.id) element.id = params.id;
                    if (params.title) {
                        const titleEl = document.createElement('h4');
                        titleEl.textContent = params.title;
                        titleEl.className = 'text-xl font-bold text-gray-900 mb-2';
                        element.appendChild(titleEl);
                    }
                    if (params.text) {
                        const textEl = document.createElement('p');
                        textEl.textContent = params.text;
                        textEl.className = 'text-gray-600';
                        element.appendChild(textEl);
                    }
                    outputArea.appendChild(element);
                    break;
                }
                case 'show': {
                    const target = document.getElementById(params.id);
                    if (target) target.classList.remove('hidden');
                    break;
                }
                case 'hide': {
                    const target = document.getElementById(params.id);
                    if (target) target.classList.add('hidden');
                    break;
                }
                case 'wait': {
                    if (params.seconds) {
                        await wait(params.seconds);
                    }
                    break;
                }
                case 'input': {
                    const element = document.createElement('input');
                    element.type = 'text';
                    element.id = params.id;
                    element.placeholder = params.placeholder || '';
                    element.className = `w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 mt-2 ${params.style}`;
                    outputArea.appendChild(element);
                    break;
                }
                case 'textarea': {
                    const element = document.createElement('textarea');
                    element.id = params.id;
                    element.placeholder = params.placeholder || '';
                    element.className = `w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 mt-2 ${params.style}`;
                    outputArea.appendChild(element);
                    break;
                }
                case 'alert': {
                    showToast(params.text, params.type);
                    break;
                }
                case 'progress': {
                    const progressContainer = document.createElement('div');
                    progressContainer.id = params.id;
                    progressContainer.className = 'w-full bg-gray-200 rounded-full mt-4';
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = `bg-indigo-600 text-xs font-medium text-white text-center p-0.5 leading-none rounded-full`;
                    progressBar.style.width = `${(params.value / params.max) * 100}%`;
                    progressBar.textContent = `${params.label || ''} ${params.value}/${params.max}`;
                    progressContainer.appendChild(progressBar);
                    outputArea.appendChild(progressContainer);
                    break;
                }
                case 'link': {
                    const element = document.createElement('a');
                    element.textContent = params.text;
                    element.href = params.url;
                    element.target = '_blank';
                    element.className = 'text-indigo-600 hover:text-indigo-800 underline mt-2 inline-block';
                    outputArea.appendChild(element);
                    break;
                }
                case 'iframe': {
                    showIframeView(params.url);
                    break;
                }
                case 'search': {
                    showCustomAlert("Search functionality is not yet implemented.");
                    break;
                }
                case 'table': {
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'overflow-x-auto mt-4';
                    if (params.id) tableContainer.id = params.id;

                    const table = document.createElement('table');
                    table.className = 'min-w-full divide-y divide-gray-200 rounded-lg shadow';
                    
                    const thead = document.createElement('thead');
                    thead.className = 'bg-gray-50';
                    const headerRow = document.createElement('tr');
                    params.headers.forEach(headerText => {
                        const th = document.createElement('th');
                        th.scope = 'col';
                        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                        th.textContent = headerText;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    tbody.className = 'bg-white divide-y divide-gray-200';
                    params.rows.forEach(rowData => {
                        const row = document.createElement('tr');
                        rowData.forEach(cellData => {
                            const td = document.createElement('td');
                            td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                            td.textContent = cellData;
                            row.appendChild(td);
                        });
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);

                    tableContainer.appendChild(table);
                    outputArea.appendChild(tableContainer);
                    break;
                }
                case 'carousel': {
                    const carouselContainer = document.createElement('div');
                    carouselContainer.id = params.id;
                    carouselContainer.className = 'carousel-container mt-4';
                    
                    const slidesContainer = document.createElement('div');
                    slidesContainer.className = 'carousel-slides';

                    if (params.images && Array.isArray(params.images)) {
                        params.images.forEach((imgUrl, index) => {
                            const slide = document.createElement('div');
                            slide.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                            const img = document.createElement('img');
                            img.src = imgUrl;
                            img.alt = `Image ${index + 1}`;
                            img.className = 'w-full';
                            slide.appendChild(img);
                            slidesContainer.appendChild(slide);
                        });
                    }
                    carouselContainer.appendChild(slidesContainer);

                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = '❮';
                    prevBtn.className = 'carousel-btn carousel-prev';
                    prevBtn.onclick = () => {
                        const slides = carouselContainer.querySelectorAll('.carousel-slide');
                        let currentSlideIndex = Array.from(slides).findIndex(slide => slide.classList.contains('active'));
                        slides[currentSlideIndex].classList.remove('active');
                        currentSlideIndex = (currentSlideIndex - 1 + slides.length) % slides.length;
                        slides[currentSlideIndex].classList.add('active');
                    };
                    carouselContainer.appendChild(prevBtn);

                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = '❯';
                    nextBtn.className = 'carousel-btn carousel-next';
                    nextBtn.onclick = () => {
                        const slides = carouselContainer.querySelectorAll('.carousel-slide');
                        let currentSlideIndex = Array.from(slides).findIndex(slide => slide.classList.contains('active'));
                        slides[currentSlideIndex].classList.remove('active');
                        currentSlideIndex = (currentSlideIndex + 1) % slides.length;
                        slides[currentSlideIndex].classList.add('active');
                    };
                    carouselContainer.appendChild(nextBtn);

                    outputArea.appendChild(carouselContainer);
                    break;
                }
                case 'chart': {
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    if (params.id) chartContainer.id = params.id;
                    
                    const canvas = document.createElement('canvas');
                    chartContainer.appendChild(canvas);
                    outputArea.appendChild(chartContainer);

                    new Chart(canvas, {
                        type: params.type,
                        data: {
                            labels: params.labels,
                            datasets: [{
                                label: params.title || 'Data',
                                data: params.data,
                                backgroundColor: ['#4F46E5', '#8B5CF6', '#EC4899', '#F97316', '#F59E0B', '#10B981'],
                                borderColor: ['#4F46E5', '#8B5CF6', '#EC4899', '#F97316', '#F59E0B', '#10B981'],
                                borderWidth: 1,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                        }
                    });
                    break;
                }
                case 'form': {
                    const form = document.createElement('form');
                    form.id = params.id;
                    form.className = 'mt-4 space-y-4';
                    form.onsubmit = (e) => e.preventDefault();
                    outputArea.appendChild(form);
                    break;
                }
                case 'submit': {
                    const form = document.getElementById(params.formId);
                    if (form) {
                        const button = document.createElement('button');
                        button.type = 'submit';
                        button.textContent = params.text;
                        button.className = `bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition ${params.style}`;
                        button.onclick = () => {
                            const formData = {};
                            const inputs = form.querySelectorAll('input, textarea');
                            inputs.forEach(input => {
                                formData[input.id] = input.value;
                            });
                            // Update the state with form data
                            state.formData = formData;
                            if (params.onClick) {
                                executeFluxCommands(params.onClick);
                            }
                        };
                        form.appendChild(button);
                    }
                    break;
                }
                case 'set': {
                    if (params.key && params.value !== undefined) {
                        state[params.key] = params.value;
                    }
                    break;
                }
                case 'get': {
                    const value = state[params.key];
                    if (value !== undefined) {
                        const p = document.createElement('p');
                        p.textContent = `Value of '${params.key}': ${JSON.stringify(value)}`;
                        p.className = 'text-sm text-gray-500 mt-2';
                        outputArea.appendChild(p);
                    } else {
                        const p = document.createElement('p');
                        p.textContent = `Key '${params.key}' not found in state.`;
                        p.className = 'text-sm text-red-500 mt-2';
                        outputArea.appendChild(p);
                    }
                    break;
                }
                case 'image': {
                    const img = document.createElement('img');
                    img.src = params.src;
                    img.alt = params.alt || '';
                    img.className = `rounded-lg shadow-md ${params.style}`;
                    if (params.width) img.style.width = params.width;
                    if (params.height) img.style.height = params.height;
                    if (params.id) img.id = params.id;
                    outputArea.appendChild(img);
                    break;
                }
                case 'video': {
                    const video = document.createElement('video');
                    video.src = params.src;
                    video.controls = params.controls === 'true';
                    video.autoplay = params.autoplay === 'true';
                    video.loop = params.loop === 'true';
                    video.muted = params.muted === 'true';
                    video.className = `rounded-lg shadow-md ${params.style}`;
                    if (params.width) video.style.width = params.width;
                    if (params.height) video.style.height = params.height;
                    if (params.id) video.id = params.id;
                    outputArea.appendChild(video);
                    break;
                }
                case 'audio': {
                    const audio = document.createElement('audio');
                    audio.src = params.src;
                    audio.controls = params.controls === 'true';
                    audio.autoplay = params.autoplay === 'true';
                    audio.loop = params.loop === 'true';
                    audio.muted = params.muted === 'true';
                    audio.className = `rounded-lg shadow-md ${params.style}`;
                    if (params.id) audio.id = params.id;
                    outputArea.appendChild(audio);
                    break;
                }
                case 'iframe.html': {
                    showIframeView(null, params.content);
                    break;
                }
                case 'codeblock': {
                    const pre = document.createElement('pre');
                    pre.className = `p-4 rounded-lg bg-gray-800 text-white overflow-x-auto my-4 ${params.style}`;
                    if (params.id) pre.id = params.id;
                    const codeEl = document.createElement('code');
                    codeEl.className = `language-${params.lang || 'plaintext'}`;
                    codeEl.textContent = params.code;
                    pre.appendChild(codeEl);
                    outputArea.appendChild(pre);
                    break;
                }
                case 'grid': {
                    const grid = document.createElement('div');
                    grid.className = `grid grid-cols-${params.columns} gap-${params.gap} mt-4 ${params.style}`;
                    if (params.id) grid.id = params.id;
                    outputArea.appendChild(grid);
                    state.currentGrid = grid; // Store a reference to the last grid
                    break;
                }
                case 'flex': {
                    const flex = document.createElement('div');
                    flex.className = `flex flex-${params.direction} justify-${params.justify} items-${params.align} mt-4 ${params.style}`;
                    if (params.id) flex.id = params.id;
                    outputArea.appendChild(flex);
                    state.currentFlex = flex; // Store a reference to the last flex container
                    break;
                }
                case 'accordion': {
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item border rounded-lg overflow-hidden mt-4';
                    if (params.id) accordionItem.id = params.id;

                    const header = document.createElement('div');
                    header.className = 'accordion-header';
                    header.innerHTML = `
                        <h4 class="font-bold text-gray-800">${params.title}</h4>
                        <span class="accordion-icon text-gray-500 text-2xl">+</span>
                    `;
                    const content = document.createElement('div');
                    content.className = 'accordion-content';
                    content.textContent = params.content;

                    header.onclick = () => {
                        accordionItem.classList.toggle('active');
                    };

                    accordionItem.appendChild(header);
                    accordionItem.appendChild(content);
                    outputArea.appendChild(accordionItem);
                    break;
                }
                case 'tabs': {
                    const tabsContainer = document.createElement('div');
                    tabsContainer.className = 'mt-4';
                    if (params.id) tabsContainer.id = params.id;

                    const tabButtons = document.createElement('div');
                    tabButtons.className = 'tab-buttons';
                    
                    const tabContent = document.createElement('div');
                    tabContent.className = 'tab-content border border-t-0 rounded-b-lg';

                    params.tabs.forEach((tabName, index) => {
                        const button = document.createElement('button');
                        button.textContent = tabName;
                        button.className = `tab-button ${index === 0 ? 'active' : ''}`;
                        button.onclick = () => {
                            tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                            tabsContainer.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                            tabsContainer.querySelector(`#${params.id}-tab-${index}`).classList.add('active');
                        };
                        tabButtons.appendChild(button);

                        const pane = document.createElement('div');
                        pane.id = `${params.id}-tab-${index}`;
                        pane.className = `tab-pane ${index === 0 ? 'active' : ''}`;
                        pane.innerHTML = params.content[index];
                        tabContent.appendChild(pane);
                    });

                    tabsContainer.appendChild(tabButtons);
                    tabsContainer.appendChild(tabContent);
                    outputArea.appendChild(tabsContainer);
                    break;
                }
                case 'rating': {
                    const ratingContainer = document.createElement('div');
                    ratingContainer.className = 'flex items-center space-x-1 mt-2';
                    if (params.id) ratingContainer.id = params.id;

                    const max = params.max || 5;
                    for (let i = 1; i <= max; i++) {
                        const star = document.createElement('span');
                        star.textContent = '★'; // Unicode star
                        star.style.fontSize = `${params.size || 24}px`;
                        star.style.color = i <= params.value ? (params.color || '#F59E0B') : '#d1d5db';
                        ratingContainer.appendChild(star);
                    }
                    outputArea.appendChild(ratingContainer);
                    break;
                }
                case 'slider': {
                    const sliderContainer = document.createElement('div');
                    sliderContainer.className = 'mt-4';
                    
                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.id = params.id;
                    slider.min = params.min || 0;
                    slider.max = params.max || 100;
                    slider.value = params.value || 0;
                    slider.step = params.step || 1;
                    slider.className = `w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer ${params.style}`;
                    outputArea.appendChild(slider);
                    break;
                }
                case 'date-picker': {
                    const label = document.createElement('label');
                    label.textContent = params.label;
                    label.className = 'block text-sm font-medium text-gray-700 mt-4';
                    outputArea.appendChild(label);
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.id = params.id;
                    if (params.value) input.value = params.value;
                    input.className = `mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 ${params.style}`;
                    outputArea.appendChild(input);
                    break;
                }
                case 'time-picker': {
                    const label = document.createElement('label');
                    label.textContent = params.label;
                    label.className = 'block text-sm font-medium text-gray-700 mt-4';
                    outputArea.appendChild(label);
                    const input = document.createElement('input');
                    input.type = 'time';
                    input.id = params.id;
                    if (params.value) input.value = params.value;
                    input.className = `mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 ${params.style}`;
                    outputArea.appendChild(input);
                    break;
                }
                case 'color-picker': {
                    const label = document.createElement('label');
                    label.textContent = params.label;
                    label.className = 'block text-sm font-medium text-gray-700 mt-4';
                    outputArea.appendChild(label);
                    const input = document.createElement('input');
                    input.type = 'color';
                    input.id = params.id;
                    if (params.value) input.value = params.value;
                    input.className = `mt-1 block w-full h-10 rounded-md border-gray-300 shadow-sm ${params.style}`;
                    outputArea.appendChild(input);
                    break;
                }
                case 'qr-code': {
                    const qrDiv = document.createElement('div');
                    qrDiv.className = 'mt-4 flex justify-center p-4 bg-white rounded-lg shadow';
                    if (params.id) qrDiv.id = params.id;
                    outputArea.appendChild(qrDiv);
                    
                    new QRCode(qrDiv, {
                        text: params.text,
                        width: params.size || 128,
                        height: params.size || 128,
                        colorDark: params.color || "#000000",
                        colorLight: params.background || "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    break;
                }
                case 'map': {
                    const mapContainer = document.createElement('div');
                    mapContainer.className = `mt-4 rounded-lg shadow-md overflow-hidden ${params.style}`;
                    if (params.id) mapContainer.id = params.id;
                    mapContainer.style.width = params.width || '100%';
                    mapContainer.style.height = params.height || '400px';

                    const iframe = document.createElement('iframe');
                    const encodedQuery = encodeURIComponent(params.query);
                    const zoom = params.zoom || 15;
                    iframe.src = `https://maps.google.com/maps?q=${encodedQuery}&t=&z=${zoom}&ie=UTF8&iwloc=&output=embed`;
                    iframe.width = '100%';
                    iframe.height = '100%';
                    iframe.style.border = '0';
                    iframe.allowFullscreen = '';
                    iframe.loading = 'lazy';
                    iframe.referrerPolicy = 'no-referrer-when-downgrade';

                    mapContainer.appendChild(iframe);
                    outputArea.appendChild(mapContainer);
                    break;
                }
                case 'toast': {
                    showToast(params.message, params.type, params.duration);
                    break;
                }
                case 'spinner': {
                    const spinner = document.createElement('div');
                    spinner.className = 'spinner mt-4';
                    spinner.style.width = `${params.size || 32}px`;
                    spinner.style.height = `${params.size || 32}px`;
                    spinner.style.borderLeftColor = params.color || '#4F46E5';
                    if (params.id) spinner.id = params.id;
                    outputArea.appendChild(spinner);
                    break;
                }
                case 'badge': {
                    const badge = document.createElement('span');
                    badge.textContent = params.text;
                    badge.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${params.color}-100 text-${params.color}-800 mt-2`;
                    outputArea.appendChild(badge);
                    break;
                }
                case 'circular-progress': {
                    const size = params.size || 100;
                    const strokeWidth = 10;
                    const radius = (size / 2) - (strokeWidth / 2);
                    const circumference = 2 * Math.PI * radius;
                    const offset = circumference - (params.value / params.max) * circumference;

                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'circular-progress mt-4';
                    progressContainer.style.width = `${size}px`;
                    progressContainer.style.height = `${size}px`;
                    if (params.id) progressContainer.id = params.id;

                    progressContainer.innerHTML = `
                        <svg width="${size}" height="${size}">
                            <circle class="text-gray-200" stroke-width="${strokeWidth}" stroke="currentColor" fill="transparent" r="${radius}" cx="${size / 2}" cy="${size / 2}" />
                            <circle class="text-${params.color || 'indigo'}-600" stroke-width="${strokeWidth}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="${size / 2}" cy="${size / 2}"
                                style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};" />
                        </svg>
                        <span class="absolute text-sm font-semibold">${Math.round((params.value / params.max) * 100)}%</span>
                    `;
                    outputArea.appendChild(progressContainer);
                    break;
                }
                case 'toggle': {
                    const toggleContainer = document.createElement('div');
                    toggleContainer.className = 'flex items-center space-x-2 mt-4';
                    if (params.id) toggleContainer.id = params.id;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `${params.id}-toggle`;
                    checkbox.className = 'sr-only peer';
                    state[params.id] = false; // Initialize state

                    const label = document.createElement('label');
                    label.htmlFor = `${params.id}-toggle`;
                    label.className = `relative inline-flex items-center cursor-pointer`;
                    label.innerHTML = `
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-900">${params.label}</span>
                    `;

                    checkbox.onchange = () => {
                        state[params.id] = checkbox.checked;
                        console.log(`Toggle '${params.id}' is now: ${state[params.id]}`);
                    };

                    toggleContainer.appendChild(checkbox);
                    toggleContainer.appendChild(label);
                    outputArea.appendChild(toggleContainer);
                    break;
                }
                case 'radio-group': {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'mt-4';
                    if (params.name) groupContainer.id = `radio-group-${params.name}`;

                    params.options.forEach(option => {
                        const radioDiv = document.createElement('div');
                        radioDiv.className = 'flex items-center';
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = params.name;
                        radio.value = option;
                        radio.id = `${params.name}-${option}`;
                        radio.className = 'focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `${params.name}-${option}`;
                        label.className = 'ml-3 block text-sm font-medium text-gray-700';
                        label.textContent = option;
                        
                        radioDiv.appendChild(radio);
                        radioDiv.appendChild(label);
                        groupContainer.appendChild(radioDiv);
                    });
                    outputArea.appendChild(groupContainer);
                    break;
                }
                case 'checkbox-group': {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'mt-4';
                    if (params.name) groupContainer.id = `checkbox-group-${params.name}`;

                    params.options.forEach(option => {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'flex items-center';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = params.name;
                        checkbox.value = option;
                        checkbox.id = `${params.name}-${option}`;
                        checkbox.className = 'focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded';
                        
                        const label = document.createElement('label');
                        label.htmlFor = `${params.name}-${option}`;
                        label.className = 'ml-3 block text-sm font-medium text-gray-700';
                        label.textContent = option;
                        
                        checkboxDiv.appendChild(checkbox);
                        checkboxDiv.appendChild(label);
                        groupContainer.appendChild(checkboxDiv);
                    });
                    outputArea.appendChild(groupContainer);
                    break;
                }
                case 'dropdown': {
                    const dropdownContainer = document.createElement('div');
                    dropdownContainer.className = 'mt-4';
                    if (params.id) dropdownContainer.id = params.id;

                    const label = document.createElement('label');
                    label.htmlFor = params.id;
                    label.className = 'block text-sm font-medium text-gray-700';
                    label.textContent = params.label;
                    outputArea.appendChild(label);

                    const select = document.createElement('select');
                    select.id = params.id;
                    select.className = 'mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md';
                    
                    params.options.forEach(optionText => {
                        const option = document.createElement('option');
                        option.textContent = optionText;
                        option.value = optionText;
                        select.appendChild(option);
                    });
                    outputArea.appendChild(select);
                    break;
                }
                case 'modal': {
                    const modal = document.createElement('div');
                    modal.id = params.id;
                    modal.className = 'flux-modal-overlay hidden';
                    modal.innerHTML = `
                        <div class="flux-modal-content">
                            <h3 class="text-2xl font-bold mb-4">${params.title}</h3>
                            <p class="text-gray-600 mb-6">${params.text}</p>
                            <button class="modal-close-btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Close</button>
                        </div>
                    `;
                    modal.querySelector('.modal-close-btn').onclick = () => {
                        modal.classList.add('hidden');
                    };
                    document.body.appendChild(modal);
                    activeModals[params.id] = modal;
                    break;
                }
                case 'button.modal': {
                    const button = document.createElement('button');
                    button.textContent = params.text;
                    button.className = `bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition ${params.style}`;
                    button.onclick = () => {
                        const modal = activeModals[params.modalId];
                        if (modal) {
                            modal.classList.remove('hidden');
                        }
                    };
                    outputArea.appendChild(button);
                    break;
                }
                case 'repeat': {
                    const count = parseInt(params.count, 10);
                    if (isNaN(count)) break;
                    
                    for (let index = 0; index < count; index++) {
                        const commands = params.commands;
                        if (commands) {
                            // Replace {index} placeholder
                            const populatedCommands = commands.replace(/{index}/g, index);
                            await executeFluxCommands(populatedCommands);
                        }
                    }
                    break;
                }
                case 'if': {
                    // Handled at a higher level to manage nested commands correctly.
                    break;
                }
                case 'fetch': {
                    try {
                        const response = await fetch(params.url, {
                            method: params.method || 'GET',
                            headers: params.headers || {},
                            body: params.body
                        });
                        const result = await response.json();
                        if (params.onSuccess) {
                            const populatedCommands = params.onSuccess.replace(/{result}/g, JSON.stringify(result));
                            await executeFluxCommands(populatedCommands);
                        }
                    } catch (error) {
                        if (params.onError) {
                            const populatedCommands = params.onError.replace(/{error}/g, JSON.stringify(error));
                            await executeFluxCommands(populatedCommands);
                        } else {
                            showError(`Fetch error: ${error.message}`);
                        }
                    }
                    break;
                }
                case 'loop': {
                    const start = parseInt(params.from, 10);
                    const end = parseInt(params.to, 10);
                    const step = parseInt(params.step, 10) || 1;
                    if (isNaN(start) || isNaN(end)) break;

                    for (let index = start; index <= end; index += step) {
                        const commands = params.commands;
                        if (commands) {
                            const populatedCommands = commands.replace(/{index}/g, index);
                            await executeFluxCommands(populatedCommands);
                        }
                    }
                    break;
                }
                case 'foreach': {
                    if (Array.isArray(params.array)) {
                        for (let index = 0; index < params.array.length; index++) {
                            const item = params.array[index];
                            const commands = params.commands;
                            if (commands) {
                                let populatedCommands = commands.replace(/{item}/g, JSON.stringify(item));
                                populatedCommands = populatedCommands.replace(/{index}/g, index);
                                await executeFluxCommands(populatedCommands);
                            }
                        }
                    }
                    break;
                }
                case 'switch': {
                    const variableValue = state[params.variable];
                    const commandsForCase = params.cases[variableValue] || params.cases.default;
                    if (commandsForCase) {
                        await executeFluxCommands(commandsForCase);
                    }
                    break;
                }
                case 'interval': {
                    if (fluxIntervals[params.id]) {
                        clearInterval(fluxIntervals[params.id]);
                    }
                    const intervalId = setInterval(() => {
                        executeFluxCommands(params.commands);
                    }, params.seconds * 1000);
                    fluxIntervals[params.id] = intervalId;
                    break;
                }
                case 'clearInterval': {
                    if (fluxIntervals[params.id]) {
                        clearInterval(fluxIntervals[params.id]);
                        delete fluxIntervals[params.id];
                    }
                    break;
                }
                case 'countdown': {
                    if (countdownTimers[params.id]) {
                        clearInterval(countdownTimers[params.id].intervalId);
                    }
                    let secondsLeft = parseInt(params.seconds, 10);
                    const intervalId = setInterval(() => {
                        if (secondsLeft > 0) {
                            if (params.onTick) {
                                const populatedCommands = params.onTick.replace(/{secondsLeft}/g, secondsLeft);
                                executeFluxCommands(populatedCommands);
                            }
                            secondsLeft--;
                        } else {
                            clearInterval(intervalId);
                            if (params.onEnd) {
                                executeFluxCommands(params.onEnd);
                            }
                            delete countdownTimers[params.id];
                        }
                    }, 1000);
                    countdownTimers[params.id] = { intervalId, secondsLeft };
                    break;
                }
                case 'stopCountdown': {
                    if (countdownTimers[params.id]) {
                        clearInterval(countdownTimers[params.id].intervalId);
                        delete countdownTimers[params.id];
                    }
                    break;
                }
                default:
                    console.warn(`Unknown command: ${commandName}`);
            }
        };

        const showError = (message) => {
            errorText.textContent = message;
            errorContainer.classList.remove('hidden');
        };

        const hideError = () => {
            errorContainer.classList.add('hidden');
        };

        editor.oninput = () => {
            hideError();
            // Optional: Auto-render on input if performance is good
            // renderFlux();
        };

        // --- Initial App Load ---
        window.renderFluxApp = () => {
            dynamicOutputContainer.classList.remove('hidden');
            renderFlux();
        };

        document.addEventListener('DOMContentLoaded', () => {
             // Initial render call, now happens without waiting for auth
             window.renderFluxApp();
        });

    </script>
</body>
</html>
